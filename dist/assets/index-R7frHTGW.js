var _t=Object.defineProperty;var Bt=(l,t,e)=>t in l?_t(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var o=(l,t,e)=>(Bt(l,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class $t{constructor(){o(this,"obj");o(this,"cursor");o(this,"trailList");const t=new PIXI.Container,e=PIXI.Texture.from("../static/cursor.png");this.cursor=PIXI.Sprite.from(e),this.cursor.anchor.set(.5),this.cursor.width=128*(1024/640)/(y.WIDTH/512),this.cursor.height=128*(1024/640)/(y.WIDTH/512);const s=PIXI.Texture.from("../static/cursortrail.png"),i=[...Array(10).keys()].map(()=>PIXI.Sprite.from(s));this.trailList=i,i.forEach(r=>{r.anchor.set(.5),r.width=64*(1024/640)/(y.WIDTH/512),r.height=64*(1024/640)/(y.WIDTH/512),t.addChild(r)}),t.addChild(this.cursor),t.x=y.OFFSET_X,t.y=y.OFFSET_Y,this.obj=t,this.obj.alpha=0}update(t,e,s){ScoreParser.CURSOR_DATA&&(this.obj.x=y.OFFSET_X+e*(y.WIDTH/512),this.obj.y=y.OFFSET_Y+s*(y.WIDTH/512),t--,this.trailList.toReversed().forEach((i,r)=>{if(t<0)return;const n=(ScoreParser.CURSOR_DATA[t].x-e)*(y.WIDTH/512),c=(ScoreParser.CURSOR_DATA[t].y-s)*(y.WIDTH/512);i.x=n,i.y=c,i.alpha=1-r/this.trailList.length,t--}))}}class Vt{constructor(){o(this,"isDragging",!1);o(this,"obj");o(this,"dragWindow");o(this,"startTimestamp");o(this,"endTimestamp");o(this,"isObjectSelecting",!1);o(this,"currentX",null);this.obj=new PIXI.Graphics().beginFill(16777215,.01).drawRect(0,0,T.WIDTH,T.HEIGHT),this.obj.interactive=!0,this.dragWindow=new PIXI.Graphics().drawRect(0,0,0,0),this.obj.addChild(this.dragWindow),this.obj.on("mousedown",t=>{if(!beatmapFile||this.isObjectSelecting)return;const{x:e,y:s}=this.obj.toLocal(t.global),i=T.WIDTH/2,r=beatmapFile.audioNode.getCurrentTime();this.startTimestamp=r-(i-e)/T.ZOOM_DISTANCE*500,this.isDragging=!0}),this.obj.on("mousemove",t=>this.handleDraggingEvent(t)),this.obj.on("wheel",t=>this.handleDraggingEvent(t)),this.obj.on("mouseup",t=>this.handleEndEvent(t)),this.obj.on("touchstart",t=>this.handleEndEvent(t)),this.obj.on("mouseleave",t=>this.handleLeaveEvent(t))}checkObjectsInWindow(){const t=[];if(this.startTimestamp&&this.endTimestamp){const e=beatmapFile.beatmapRenderData.objectsController.objectsList,s=(r,n)=>{let c=this.startTimestamp,a=this.endTimestamp;return c>a&&(a=c,c=this.endTimestamp),r.obj.endTime<c?-1:r.obj.time>a?1:0},i=binarySearch(e,null,s);if(i!==-1){let r=i-1,n=i+1;for(;r>=0&&s(e[r])===0;)t.push(e[r]),r--;for(t.reverse(),t.push(e[i]);n<=e.length-1&&s(e[n])===0;)t.push(e[n]),n++}}this.isObjectSelecting||(selectedHitObject=t.map(e=>e.obj.time))}handleDraggingEvent(t){if(!this.isDragging)return;const{x:e,y:s}=this.obj.toLocal(t.global),i=T.WIDTH/2,r=beatmapFile.audioNode.getCurrentTime();this.endTimestamp=r-(i-e)/T.ZOOM_DISTANCE*500,this.currentX=e,this.checkObjectsInWindow()}handleEndEvent(t){this.checkObjectsInWindow(),this.startTimestamp=null,this.endTimestamp=null,this.isObjectSelecting=!1,this.isDragging=!1,this.currentX=-1}handleLeaveEvent(t){this.isDragging&&(this.checkObjectsInWindow(),this.startTimestamp=null,this.endTimestamp=null,this.isObjectSelecting=!1,this.isDragging=!1,this.currentX=-1)}resize(){this.obj.clear().beginFill(16777215,.01).drawRect(0,0,T.WIDTH,T.HEIGHT)}draw(t){if(!this.startTimestamp||!this.endTimestamp){this.dragWindow.clear();return}const e=T.WIDTH/2;this.isDragging&&this.currentX&&(this.endTimestamp=t-(e-this.currentX)/T.ZOOM_DISTANCE*500,this.checkObjectsInWindow());let s=this.startTimestamp,i=this.endTimestamp;s>i&&(i=s,s=this.endTimestamp);const r=t-s,n=t-i,c=Math.max(e-r/500*T.ZOOM_DISTANCE,0),a=e-n/500*T.ZOOM_DISTANCE;this.dragWindow.clear().beginFill(16777215,.2).drawRect(c,0,a-c,T.HEIGHT)}}class Yt{constructor(){o(this,"obj");this.obj=new PIXI.Sprite(T.beatLines.tickTexture),this.obj.anchor.set(.5,1),T.beatLines.obj.addChild(this.obj)}draw(t,e,s,i){const r=T.WIDTH/2;this.obj.tint=Rt.BEAT_LINE_COLOR[t]??9605778,this.obj.x=r+e*s-i,this.obj.y=T.HEIGHT,t!==1&&this.obj.scale.set(1,.5)}drawLine(t,e,s){const i=T.WIDTH/2,r=s-t;this.obj.tint=e==="beatStep"?14894675:1821728,this.obj.x=i-r/500*T.ZOOM_DISTANCE,this.obj.y=T.HEIGHT,this.obj.alpha=.9,this.obj.scale.set(1,3)}}class jt{constructor(t){o(this,"greenLine");o(this,"sv");o(this,"sample");this.greenLine=t;const e=new PIXI.Text(`${this.greenLine.svMultiplier.toFixed(2)}x`,{fontFamily:"Torus",fontSize:12,fontWeight:500,align:"center",tint:1447446});let{width:s,height:i}=e;s+=10,i+=3,this.sv=new PIXI.Graphics().beginFill(9040035).drawRoundedRect(-s/2,0,s,i,10),this.sv.addChild(e),this.sv.cullable=!0,e.x=0,e.y=1,e.anchor.set(.5,0),this.sv.y=0;let r=this.greenLine.sampleIdx!=0?`:C${this.greenLine.sampleIdx}`:"";const n=new PIXI.Text(`${HitSound.HIT_SAMPLES[this.greenLine.sampleSet][0].toUpperCase()}${r}`,{fontFamily:"Torus",fontSize:12,fontWeight:500,tint:1447446});n.x=0,n.anchor.set(.5);let{width:c,height:a}=n;c+=10,a+=3,n.y=-a/2,this.sample=new PIXI.Graphics().beginFill(16449397).drawRoundedRect(-c/2,-a,c,a,10),this.sample.addChild(n),this.sample.cullable=!0,this.sample.y=T.HEIGHT}static findGreenLineInRange(t){var n;const e=T.WIDTH/2/T.ZOOM_DISTANCE*500+t,s=((n=z.CURRENT_SV)==null?void 0:n.time)??0;if(e<s)return[];let i=St(T.beatLines.greenLines,s,(c,a)=>c.greenLine.time<a?-1:c.greenLine.time>a?1:0);for(;i>0&&T.beatLines.greenLines[i].greenLine.time>=t-T.WIDTH/2/T.ZOOM_DISTANCE*500;)i--;const r=[];for(;i<T.beatLines.greenLines.length&&T.beatLines.greenLines[i].greenLine.time<=e;)r.push(T.beatLines.greenLines[i++]);return r}draw(t){const e=T.WIDTH/2,s=t-this.greenLine.time;this.sv.x=Math.max(e-s/500*T.ZOOM_DISTANCE,this.sv.width/2+5),this.sample.x=Math.max(e-s/500*T.ZOOM_DISTANCE,this.sample.width/2+5),this.sample.y=T.HEIGHT}}class Rt{constructor(){o(this,"obj");o(this,"ticks",[]);o(this,"tickTexture");o(this,"greenLines",[]);o(this,"drawList",[]);this.obj=new PIXI.Container,this.createTickTexture()}createTickTexture(){const t=new PIXI.Graphics().beginFill(16777215).drawRect(0,0,2,40).endFill(),{width:e,height:s}=t,i=PIXI.RenderTexture.create({width:e,height:s,multisample:PIXI.MSAA_QUALITY.MEDIUM});T.APP.renderer.render(t,{renderTexture:i,transform:new PIXI.Matrix(1,0,0,1,e/2,s/2)}),T.APP.renderer.framebuffer.blit(),t.destroy(!0),this.tickTexture=i}getLineInRange(t,e,s){const i=St(I[s],t,(d,u)=>d.time<u?-1:d.time>u?1:0),r=[],n=I[s][i];n.time>=t-e&&n.time<=t+e&&r.push(n);let c=i-1,a=i+1;for(;c>=0&&I[s][c].time>=t-e&&I[s][c].time<=t+e;)r.push(I[s][c--]);for(;a<I[s].length&&I[s][a].time>=t-e&&I[s][a].time<=t+e;)r.push(I[s][a++]);return r}draw(t){const{beatstep:e,time:s}=I.beatStepsList.findLast(p=>p.time<t)??I.beatStepsList[0],i=T.WIDTH/2/T.ZOOM_DISTANCE*500,r=this.getLineInRange(t,i,"beatStepsList"),n=this.getLineInRange(t,i,"timingPointsList"),c=parseInt(beatsnap),a=e/c,d=t-s,u=Math.round(d/a),f=s+u*a,m=a*(T.ZOOM_DISTANCE/500),h=(t-f)*(T.ZOOM_DISTANCE/500),g=Math.floor(i/a);for(;this.ticks.length<g*2+1+r.length+n.length;)this.ticks.push(new Yt);for(;this.ticks.length>g*2+1+r.length+n.length;){const p=this.ticks.pop();if(!p)break;this.obj.removeChild(p.obj),p.obj.destroy()}let b=0;for(let p=-g;p<=g;p++){const A=f+p*a-s,O=Math.round(A/e),w=s+O*e;let M=Math.round(e/Math.abs(w-(f+p*a)));(c===5||c===10)&&(M=5),M>48&&(M=1),this.ticks[p+g].draw(M,p,m,h),b++}for(let p=0;p<n.length;p++)this.ticks[p+b].drawLine(n[p].time,"timingPoint",t);b+=n.length;for(let p=0;p<r.length;p++)this.ticks[p+b].drawLine(r[p].time,"beatStep",t);this.drawList.forEach(p=>{this.obj.removeChild(p.sv),this.obj.removeChild(p.sample)}),this.drawList=[],T.SHOW_GREENLINE&&(this.drawList=jt.findGreenLineInRange(t),this.drawList.forEach(p=>{this.obj.addChild(p.sv),this.obj.addChild(p.sample),p.draw(t)}))}}o(Rt,"BEAT_LINE_COLOR",{1:16777215,2:16711680,3:11994807,4:3307238,5:15132165,6:8666756,7:15132165,8:15132165,9:15132165});const x=class x{static init(){x.WIDTH=parseInt(getComputedStyle(document.querySelector(".timeline")).width)*window.devicePixelRatio,x.HEIGHT=parseInt(getComputedStyle(document.querySelector(".timeline")).height)*window.devicePixelRatio,x.APP=new PIXI.Application({width:x.WIDTH,height:x.HEIGHT,antialias:!0,autoDensity:!0,backgroundAlpha:0}),x.hitArea=new Vt,x.APP.stage.addChild(x.hitArea.obj),x.obj=new PIXI.Container,x.APP.stage.addChild(x.obj),x.centerLine=new PIXI.Graphics().lineStyle({width:1,color:16777215,alignment:1}).moveTo(-1,0).lineTo(-1,1).moveTo(1,0).lineTo(1,1),x.APP.stage.addChild(x.centerLine),x.beatLines=new Rt,x.APP.stage.addChild(x.beatLines.obj),x.APP.view.style.transform=`scale(${1/window.devicePixelRatio})`,document.querySelector(".timeline").appendChild(x.APP.view)}static resize(){let{width:t,height:e}=getComputedStyle(document.querySelector(".timeline"));t=parseInt(t)*window.devicePixelRatio,e=parseInt(e)*window.devicePixelRatio,!(x.WIDTH===t&&x.HEIGHT===e)&&(x.WIDTH=t,x.HEIGHT=e,x.APP.renderer.resize(x.WIDTH,x.HEIGHT),x.APP.view.style.transform=`scale(${1/window.devicePixelRatio})`,x.hitArea.resize())}static draw(t){var c;if(!((c=beatmapFile==null?void 0:beatmapFile.beatmapRenderData)!=null&&c.objectsController.objectsList))return;x.beatLines.draw(t),x.hitArea.draw(t),x.centerLine.x=x.WIDTH/2,x.centerLine.scale.set(1,x.HEIGHT);const e=beatmapFile.beatmapRenderData.objectsController.objectsList,s=x.WIDTH/2/x.ZOOM_DISTANCE*500+x.LOOK_AHEAD,i=[],r=(a,d)=>a.obj.endTime<d-s?-1:a.obj.time>d+s?1:0,n=yt(e,t,r);if(n!==-1){let a=n-1,d=n+1;for(;a>=0&&r(e[a],t)===0;)i.push(e[a]),a--;for(i.reverse(),i.push(e[n]);d<=e.length-1&&r(e[d],t)===0;)i.push(e[d]),d++}this.DRAW_LIST.forEach(a=>{var d;(d=a.timelineObject)==null||d.removeSelfFromContainer(x.hitArea.obj)}),this.DRAW_LIST=i,i.toReversed().forEach(a=>{a.timelineObject&&(a.timelineObject.addSelfToContainer(x.hitArea.obj),a.timelineObject.draw(t))})}static destruct(){x.obj.removeChildren().forEach(e=>e.destroy())}};o(x,"obj"),o(x,"hitArea"),o(x,"centerLine"),o(x,"beatLines"),o(x,"APP"),o(x,"WIDTH"),o(x,"HEIGHT"),o(x,"ZOOM_DISTANCE",200),o(x,"LOOK_AHEAD",300),o(x,"DRAW_LIST",[]),o(x,"SHOW_GREENLINE",!1);let T=x;const st=class st{constructor(){o(this,"buf");o(this,"src");o(this,"phazeNode");o(this,"currentTime",.001);o(this,"startTime",0);o(this,"absStartTime",0);o(this,"isPlaying",!1);o(this,"isLoaded",!1);st.SOFT_OFFSET=JSON.parse(localStorage.getItem("settings")).mapping.offset}async createBufferNode(t){this.buf=await audioCtx.decodeAudioData(t),urlParams.get("b")&&urlParams.get("t")&&urlParams.get("b")===currentMapId&&this.seekTo(parseInt(urlParams.get("t"))),await audioCtx.audioWorklet.addModule("../lib/phase-vocoder.min.js"),this.phazeNode=new AudioWorkletNode(audioCtx,"phase-vocoder-processor"),this.gainNode=audioCtx.createGain(),this.isLoaded=!0}seekTo(t){if(t!==0&&!t||this.buf===void 0||t>this.buf.duration*1e3)return;const e=this.isPlaying;this.isPlaying&&this.pause(),this.currentTime=t,e&&this.play()}play(t){if(!this.isPlaying&&this.gainNode){this.isPlaying=!0,this.src=audioCtx.createBufferSource(),this.gainNode.gain.value=musicVol*masterVol,this.src.buffer=this.buf,this.src.playbackRate.value=playbackRate,this.src.onended=()=>{this.getCurrentTime()>=this.buf.duration*1e3&&(console.log("Ended"),this.pause(),this.seekTo(0))};let e=this.phazeNode.parameters.get("pitchFactor");e.value=1/playbackRate,this.src.connect(this.phazeNode),this.phazeNode.connect(this.gainNode),this.gainNode.connect(audioCtx.destination),this.startTime=audioCtx.currentTime*1e3,this.absStartTime=performance.now(),this.src.start(audioCtx.currentTime-(st.SOFT_OFFSET<0?st.SOFT_OFFSET/1e3:0),this.currentTime/1e3+60/1e3+(st.SOFT_OFFSET>=0?st.SOFT_OFFSET/1e3:0)),document.querySelector("#playButton").style.backgroundImage="url(./static/pause.png)"}}pause(){this.isPlaying&&(this.src.stop(),this.src.disconnect(),this.phazeNode.disconnect(),this.gainNode.disconnect(),this.currentTime+=(performance.now()-this.absStartTime)*playbackRate,this.isPlaying=!1,document.querySelector("#playButton").style.backgroundImage="")}getCurrentTime(){return this.isPlaying?this.currentTime+(performance.now()-this.absStartTime)*playbackRate:this.currentTime}get duration(){var t;return((t=this.buf)==null?void 0:t.duration)*1e3}};o(st,"SOFT_OFFSET",0);let ft=st;const J=class J{constructor(t,e){o(this,"audioObj");o(this,"sliderHead",!1);o(this,"sliderTail",!1);o(this,"vol",1);o(this,"isPlaying",!1);o(this,"srcs",[]);o(this,"gainNode");o(this,"currentTimeout");this.audioObj=t,this.vol=e??1,t.some(s=>s.includes("sliderslide")||s.includes("sliderwhistle"))&&(this.gainNode=audioCtx.createGain(),this.gainNode.gain.value=this.vol)}play(t){this.srcs=[],this.audioObj.forEach(e=>{const s=audioCtx.createBufferSource(),i=this.gainNode??audioCtx.createGain();if(this.gainNode||(i.gain.value=this.vol),J.SAMPLES.MAP[e])s.buffer=J.SAMPLES.MAP[e];else{const r=L.SKIN_ENUM[skinning.type],n=r!=="CUSTOM"||!J.SAMPLES.CUSTOM[L.SKIN_IDX]?J.SAMPLES[r]:J.SAMPLES.CUSTOM[L.SKIN_IDX];s.buffer=n[e.replaceAll(/\d/g,"")]}s.connect(t?this.gainNode:i),s.ended=()=>{s.disconnect(),i.disconnect()},i.connect(J.masterGainNode),s.start(),this.isPlaying=!0,t&&(s.loop=!0),this.srcs.push(s)})}playLoop(t,e,s){t&&e&&!this.isPlaying&&beatmapFile.audioNode.isPlaying&&(clearTimeout(this.currentTimeout),this.play(!0),this.currentTimeout=setTimeout(()=>{this.srcs.forEach(i=>i.stop()),this.isPlaying=!1},s??0)),(!t||!e||!beatmapFile.audioNode.isPlaying)&&(this.srcs.forEach(i=>{i.stop(),i.disconnect()}),this.isPlaying=!1)}};o(J,"masterGainNode"),o(J,"SAMPLES",{ARGON:{},LEGACY:{},CUSTOM:{},MAP:{}}),o(J,"DEFAULT_SAMPLES",{ARGON:{},LEGACY:{}});let q=J;function Kt(){const l=document.querySelector("#settingsPanel"),t=document.querySelector("#block");l.style.left=l.style.left===""?"0px":"",l.style.opacity=l.style.opacity===""?"1":"",t.style.display=l.style.opacity==="1"?"block":"",setTimeout(()=>{t.style.opacity=l.style.opacity==="1"?.5:""},0)}document.querySelector("#settingsButton").onclick=Kt;document.body.addEventListener("click",l=>{const t=document.querySelector("#settingsPanel").contains(l.target);document.querySelector("#settingsButton").contains(l.target)||t||(settingsPanel.style.left="",settingsPanel.style.opacity="",block.style.opacity=settingsPanel.style.opacity==="1"?.5:"",setTimeout(()=>{block.style.display=settingsPanel.style.opacity==="1"?"block":""},200))});document.body.addEventListener("change",l=>{const t=l.target;if(t.checked&&["nerinyan","custom","sayobot","chimu"].includes(t.value)){const e=JSON.parse(localStorage.getItem("settings"));e.mirror.val=t.value,localStorage.setItem("settings",JSON.stringify(e))}});function zt(l){const t=JSON.parse(localStorage.getItem("settings"));t.mirror.custom=l.value,localStorage.setItem("settings",JSON.stringify(t))}document.querySelector("#custom-mirror").onblur=()=>zt(document.querySelector("#custom-mirror"));function Zt(l){document.querySelector("#overlay").style.backgroundColor=`rgba(0 0 0 / ${l.value})`,document.querySelector("#bgDimVal").innerHTML=`${parseInt(l.value*100)}%`;const t=JSON.parse(localStorage.getItem("settings"));t.background.dim=l.value,localStorage.setItem("settings",JSON.stringify(t))}document.querySelector("#dim").oninput=()=>Zt(document.querySelector("#dim"));function Jt(l){masterVol=l.value,document.querySelector("#masterVal").innerHTML=`${parseInt(l.value*100)}%`;const t=JSON.parse(localStorage.getItem("settings"));t.volume.master=l.value,localStorage.setItem("settings",JSON.stringify(t)),beatmapFile!==void 0&&(beatmapFile.audioNode.gainNode.gain.value=masterVol*musicVol,q.masterGainNode.gain.value=masterVol*hsVol)}document.querySelector("#master").oninput=()=>Jt(document.querySelector("#master"));function Qt(l){musicVol=l.value,document.querySelector("#musicVal").innerHTML=`${parseInt(l.value*100)}%`;const t=JSON.parse(localStorage.getItem("settings"));t.volume.music=l.value,localStorage.setItem("settings",JSON.stringify(t)),beatmapFile!==void 0&&(beatmapFile.audioNode.gainNode.gain.value=masterVol*musicVol)}document.querySelector("#music").oninput=()=>Qt(document.querySelector("#music"));function te(l){hsVol=l.value,document.querySelector("#effectVal").innerHTML=`${parseInt(l.value/.4*100)}%`;const t=JSON.parse(localStorage.getItem("settings"));t.volume.hs=l.value,localStorage.setItem("settings",JSON.stringify(t)),beatmapFile!==void 0&&(q.masterGainNode.gain.value=masterVol*hsVol)}document.querySelector("#effect").oninput=()=>te(document.querySelector("#effect"));function ee(l){ft.SOFT_OFFSET=l.value,document.querySelector("#softoffsetVal").innerHTML=`${parseInt(l.value)}ms`;const t=JSON.parse(localStorage.getItem("settings"));t.mapping.offset=l.value,localStorage.setItem("settings",JSON.stringify(t)),beatmapFile}document.querySelector("#softoffset").oninput=()=>ee(document.querySelector("#softoffset"));function kt(l){beatsnap=l.value,document.querySelector("#beatVal").innerHTML=`1/${l.value}`;const t=JSON.parse(localStorage.getItem("settings"));t.mapping.beatsnap=l.value,localStorage.setItem("settings",JSON.stringify(t))}document.querySelector("#beat").oninput=()=>kt(document.querySelector("#beat"));function ie(l){const e={addStacking:!0,mods:["HARD_ROCK","EASY","DOUBLE_TIME","HALF_TIME"].filter((n,c)=>l[c])},s=osuPerformance.parseBlueprint(beatmapFile.osuFile),i=osuPerformance.buildBeatmap(s,e),r=osuPerformance.calculateDifficultyAttributes(i,!0)[0];document.querySelector("#CS").textContent=et(i.difficulty.circleSize),document.querySelector("#AR").textContent=et(r.approachRate),document.querySelector("#OD").textContent=et(r.overallDifficulty),document.querySelector("#HP").textContent=et(i.difficulty.drainRate),document.querySelector("#SR").textContent=`${et(r.starRating)}★`,document.querySelector("#SR").style.backgroundColor=xt(r.starRating),r.starRating>=6.5?document.querySelector("#SR").style.color="hsl(45deg, 100%, 70%)":document.querySelector("#SR").style.color="black"}function se(l){mods[l.name]=!mods[l.name],sliderAppearance[l.name]=!sliderAppearance[l.name],mapping[l.name]=!mapping[l.name];const t=mods.DT?1.5:1,e=mods.HT?.75:1;if(["snaking","hitAnim","ignoreSkin"].includes(l.name)){const i=JSON.parse(localStorage.getItem("settings"));i.sliderAppearance[l.name]=sliderAppearance[l.name],localStorage.setItem("settings",JSON.stringify(i))}if(["showGreenLine"].includes(l.name)){const i=JSON.parse(localStorage.getItem("settings"));i.mapping[l.name]=mapping[l.name],localStorage.setItem("settings",JSON.stringify(i)),T.SHOW_GREENLINE=mapping[l.name],mapping[l.name]?document.querySelector(".timelineContainer").style.height="":document.querySelector(".timelineContainer").style.height="60px"}if(!beatmapFile)return;const s=beatmapFile.audioNode.isPlaying;beatmapFile.audioNode.isPlaying&&beatmapFile.audioNode.pause(),playbackRate=1*t*e,I.updateModdedStats(),s&&beatmapFile.audioNode.play(),ie([mods.HR,mods.EZ,mods.DT,mods.HT])}[...document.querySelectorAll("input[type=checkbox]")].forEach(l=>{l.onclick=()=>se(l)});function re(){const l=document.querySelector("#skinDropdown");if(!l.open){l.show(),l.style.display="flex";return}l.close(),l.style.display=""}document.querySelector(".skinSelector").onclick=re;document.body.addEventListener("click",l=>{const t=document.querySelector("#skinDropdown").getBoundingClientRect(),e=document.querySelector(".seekTo").getBoundingClientRect();(l.clientX<t.left||l.clientX>t.right||l.clientY<t.top||l.clientY>t.bottom)&&document.querySelector("#skinDropdown").open&&l.target!==document.querySelector(".skinSelector")&&(document.querySelector("#skinDropdown").close(),document.querySelector("#skinDropdown").style.display=""),(l.clientX<e.left||l.clientX>e.right||l.clientY<e.top||l.clientY>e.bottom)&&document.querySelector(".seekTo").open&&l.target!==document.querySelector("#timeContainer")&&l.target!==document.querySelector("#timeContainer canvas")&&At()});[...document.querySelectorAll(".skinName")].forEach(l=>{l.onclick=Gt});class Nt{constructor(t,e){o(this,"isFromFile",!1);o(this,"osuFile");o(this,"mapId");o(this,"audioBlobURL");o(this,"backgroundBlobURL");o(this,"audio");o(this,"audioArrayBuffer");o(this,"audioNode");o(this,"beatmapRenderData");o(this,"hitsoundList",[]);o(this,"title");o(this,"artist");o(this,"diff");o(this,"md5Map");o(this,"isLoaded",!1);this.mapId=t,this.isFromFile=e,this.constructMap()}async getOsuFile(){const t=(await axios.get(`https://tryz.vercel.app/api/b/${this.mapId}/osu`)).data;this.osuFile=t}async readBlobAsBuffer(t){return await new Promise(s=>{let i=new FileReader;i.onload=r=>s(i.result),i.readAsArrayBuffer(t)})}async downloadOsz(t){try{const s=JSON.parse(localStorage.getItem("settings")).mirror.val,i=document.querySelector("#custom-mirror").value,r={nerinyan:"https://api.nerinyan.moe/d/",sayobot:"https://dl.sayobot.cn/beatmaps/download/novideo/",chimu:"https://chimu.moe/d/"};if(!r[s]&&i==="")throw"You need a beatmap mirror download link first!";let n;return s!=="nerinyan"?n=(await axios.create({baseURL:r[s]??i}).get(`${t}`,{responseType:"blob",onDownloadProgress:a=>{document.querySelector("#loadingText").textContent=`Downloading map: ${(a.progress*100).toFixed(2)}%`}})).data:n=await(await ky.get(`${t}/`,{prefixUrl:r[s]??i,onDownloadProgress:a=>{document.querySelector("#loadingText").textContent=`Downloading map: ${(a.percent*100).toFixed(2)}%`},headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS, POST, HEAD"}})).blob(),dropBlob=n,n}catch(e){throw console.log(e),`This map is not available on the selected beatmap provider
Please open the settings to choose another one.`}}async getOsz(){var G,B,Y,C,P,v,N,_,F,K,X;let t;if(!this.isFromFile){if(t=(await axios.get(`https://tryz.vercel.app/api/b/${this.mapId}`)).data,this.artist=t.artist_unicode,this.title=t.title_unicode,this.diff=t.beatmaps.filter(j=>j.id===parseInt(this.mapId))[0].version,document.title=`${this.artist} - ${this.title} [${this.diff}] | JoSu!`,t.beatmaps.filter(j=>j.id===parseInt(this.mapId))[0].mode!=="osu")throw new Error("Not a standard map!");document.querySelector("#artistTitle").innerHTML=`${t.artist} - ${t.title}`,document.querySelector("#versionCreator").innerHTML=`Difficulty: <span>${t.beatmaps.find(j=>j.id==this.mapId).version}</span> - Mapset by <span>${t.creator}</span>`}const e=t==null?void 0:t.id;e&&!this.isFromFile?document.querySelector("#metadata").href=`https://osu.ppy.sh/beatmapsets/${e}#osu/${this.mapId}`:document.querySelector("#metadata").removeAttribute("href");const s=this.isFromFile?dropBlob:await this.downloadOsz(e),i=new zip.BlobReader(s),r=new zip.ZipReader(i),n=await r.getEntries();if(this.isFromFile){const W=await n.filter($=>$.filename===diffFileName).at(0).getData(new zip.BlobWriter("text/plain"));this.osuFile=await W.text();const U=this.osuFile.split(`\r
`),Q=(Y=U.filter($=>/Artist:.+/g.test($)).at(0))==null?void 0:Y.replace("Artist:",""),lt=(C=U.filter($=>/ArtistUnicode:.+/g.test($)).at(0))==null?void 0:C.replace("ArtistUnicode:",""),gt=(P=U.filter($=>/Title:.+/g.test($)).at(0))==null?void 0:P.replace("Title:",""),It=(v=U.filter($=>/TitleUnicode:.+/g.test($)).at(0))==null?void 0:v.replace("TitleUnicode:",""),bt=(N=U.filter($=>/Creator:.+/g.test($)).at(0))==null?void 0:N.replace("Creator:",""),dt=(_=U.filter($=>/Version:.+/g.test($)).at(0))==null?void 0:_.replace("Version:",""),nt=(F=U.filter($=>/BeatmapID:.+/g.test($)).at(0))==null?void 0:F.replace("BeatmapID:",""),ct=(K=U.filter($=>/BeatmapSetID:.+/g.test($)).at(0))==null?void 0:K.replace("BeatmapSetID:","");document.querySelector("#artistTitle").innerHTML=`${Q} - ${gt}`,document.querySelector("#versionCreator").innerHTML=`Difficulty: <span>${dt}</span> - Mapset by <span>${bt}</span>`,document.title=`${lt} - ${It} [${dt}] | JoSu!`,ct&&nt&&ct!==-1&&nt!==-1?(window.history.pushState({},"JoSu!",`${origin}${origin.includes("github.io")?"/beatmap-viewer-web":""}/?b=${nt}`),document.querySelector("#metadata").href=`https://osu.ppy.sh/beatmapsets/${ct}#osu/${nt}`):window.history.pushState({},"JoSu!",`${origin}${origin.includes("github.io")?"/beatmap-viewer-web":""}/`)}else{await this.getOsuFile();const j=document.querySelector(".difficultyList");j.innerHTML="";const W=[];for(const U of n){if(U.filename.split(".").at(-1)!=="osu")continue;const lt=await(await U.getData(new zip.BlobWriter("text/plain"))).text(),gt=(G=lt.split(`\r
`).filter(Tt=>/Mode:\s[0-9]+/g.test(Tt)).at(0))==null?void 0:G.replace("Mode: ","");if(parseInt(gt)!==0)continue;const It={addStacking:!0,mods:[]},bt=osuPerformance.parseBlueprint(lt),dt=osuPerformance.buildBeatmap(bt,It),nt=osuPerformance.calculateDifficultyAttributes(dt,!0)[0],ct=(B=lt.split(`\r
`).filter(Tt=>/Version:.+/g.test(Tt)).at(0))==null?void 0:B.replace("Version:",""),$=de({name:ct,fileName:U.filename,starRating:nt.starRating});W.push($)}W.sort((U,Q)=>-U.starRating+Q.starRating);for(const U of W)j.appendChild(U.ele)}const c=["HARD_ROCK","EASY","DOUBLE_TIME","HALF_TIME"],a=[mods.HR,mods.EZ,mods.DT,mods.HT],d={addStacking:!0,mods:c.filter((j,W)=>a[W])},u=osuPerformance.parseBlueprint(this.osuFile),f=osuPerformance.buildBeatmap(u,d),m=osuPerformance.calculateDifficultyAttributes(f,!0)[0];document.querySelector("#CS").textContent=et(f.difficulty.circleSize),document.querySelector("#AR").textContent=et(f.difficulty.approachRate),document.querySelector("#OD").textContent=et(f.difficulty.overallDifficulty),document.querySelector("#HP").textContent=et(f.difficulty.drainRate),document.querySelector("#SR").textContent=`${et(m.starRating)}★`,document.querySelector("#SR").style.backgroundColor=xt(m.starRating),m.starRating>=6.5?document.querySelector("#SR").style.color="hsl(45deg, 100%, 70%)":document.querySelector("#SR").style.color="black";const h=this.osuFile.split(`\r
`).filter(j=>j.match(/AudioFilename: /g))[0].replace("AudioFilename: ",""),g=(X=this.osuFile.split(`\r
`).filter(j=>j.match(/0,0,"*.*"/g)).at(0))==null?void 0:X.match(/"[;\+\/\\\!\(\)\[\]\{\}\&\%\#a-zA-Z0-9\s\._-]+\.[a-zA-Z0-9]+"/g)[0].replaceAll('"',"");console.log(h,g),document.querySelector("#loadingText").innerHTML="Setting up Audio<br>Might take long if the audio file is large";const b=n.filter(j=>j.filename===h).at(0);if(!b)throw"This map has no audio file";const p=await b.getData(new zip.BlobWriter(`audio/${h.split(".").at(-1)}`));this.audioBlobURL=URL.createObjectURL(p);const A=await this.readBlobAsBuffer(p);console.log("Audio Loaded");const O=n.filter(j=>j.filename===g).at(0);if(O){const j=await O.getData(new zip.BlobWriter(`image/${g.split(".").at(-1)}`));this.backgroundBlobURL=URL.createObjectURL(j),console.log("Background Loaded"),document.querySelector("#background").src=`${this.backgroundBlobURL}`,document.body.style.backgroundImage=`url(${this.backgroundBlobURL})`;const W=new Image;W.src=this.backgroundBlobURL,W.complete?wt(W):W.addEventListener("load",()=>wt(W))}const w=n.filter(j=>/(normal|soft|drum)-(hitnormal|hitwhistle|hitclap|hitfinish|slidertick|sliderwhistle|sliderslide)([1-9][0-9]*)?/.test(j.filename)),M=[];document.querySelector("#loadingText").innerHTML="Setting up Hitsounds<br>Might take long if there are many hitsound files";for(const j of w){const W=new zip.BlobWriter(`audio/${j.filename.split(".").at(-1)}`),U=await j.getData(W),Q=await this.readBlobAsBuffer(U);M.push({filename:j.filename,buf:Q})}return this.hitsoundList=M,console.log("Hitsound Loaded"),r.close(),document.querySelector("#loadingText").innerHTML="Setting up HitObjects",console.log("Get .osz completed"),A}async loadHitsounds(){q.SAMPLES.MAP={};for(const t of this.hitsoundList){const e=t.filename.replace(t.filename.match(/normal|soft|drum/)[0],"").replaceAll(t.filename.match(/hitnormal|hitwhistle|hitfinish|hitclap|slidertick|sliderwhistle|sliderslide/),"").replace("-","").split(".")[0];await ue(t.filename.split(".")[0].replaceAll(`${e}`,""),e===""?1:parseInt(e),t.buf)}}async constructMap(){try{y.CONTAINER.removeChildren().forEach(i=>i.destroy()),T.destruct(),currentMapId=this.mapId,document.querySelector(".loading").style.display="",document.querySelector(".loading").style.opacity=1;const e=await this.getOsz();this.audioNode=new ft,await this.loadHitsounds(),document.querySelector("#loadingText").textContent="Setting up Audio",await this.audioNode.createBufferNode(e),document.querySelector("#loadingText").textContent="Setting up HitObjects",this.md5Map=CryptoJS.MD5(this.osuFile).toString(),this.beatmapRenderData=new I(this.osuFile,0),document.querySelector(".loading").style.opacity=0,document.querySelector(".loading").style.display="none",document.querySelector("#loadingText").textContent="Getting map data",document.querySelector("#choose-diff").disabled=!1,document.querySelector("#close").disabled=!1,ScoreParser.REPLAY_DATA&&ScoreParser.REPLAY_DATA.md5map!==this.md5Map&&ScoreParser.reset(),ScoreParser.CURSOR_DATA?(ScoreParser.eval(),document.querySelector("#HD").disabled=!0,document.querySelector("#HR").disabled=!0,document.querySelector("#DT").disabled=!0,document.querySelector("#EZ").disabled=!0,document.querySelector("#HT").disabled=!0,calculateCurrentSR([mods.HR,mods.EZ,mods.DT,mods.HT])):(document.querySelector("#HD").disabled=!1,document.querySelector("#HR").disabled=!1,document.querySelector("#DT").disabled=!1,document.querySelector("#EZ").disabled=!1,document.querySelector("#HT").disabled=!1,document.querySelector("#HD").checked=!1,document.querySelector("#HR").checked=!1,document.querySelector("#DT").checked=!1,document.querySelector("#EZ").checked=!1,document.querySelector("#HT").checked=!1),y.appResize(),document.onkeydown=i=>{switch(i=i||window.event,i.key){case"ArrowLeft":ot(i.shiftKey,!1);break;case"ArrowRight":ot(i.shiftKey,!0);break;case" ":document.querySelector(".difficultySelector").style.display!=="block"&&document.activeElement!==document.querySelector("#jumpToTime")&&Wt();break}if(i.key==="c"&&i.ctrlKey&&selectedHitObject.length){const r=this.beatmapRenderData.objectsController.objectsList.filter(u=>selectedHitObject.includes(u.obj.time)),n=r.reduce((u,f)=>u.obj.time>f.obj.time?f:u),c=Math.floor(n.obj.time%1e3).toString().padStart(3,"0"),a=Math.floor(n.obj.time/1e3%60).toString().padStart(2,"0"),d=Math.floor(n.obj.time/1e3/60).toString().padStart(2,"0");navigator.clipboard.writeText(`${d}:${a}:${c} (${r.map(u=>u.obj.comboIdx).join(",")}) - `),new Notification("Object(s) timestamp copied").notify()}if(i.key==="a"&&i.ctrlKey){if(document.activeElement===document.querySelector("#jumpToTime"))return;i.preventDefault(),selectedHitObject=this.beatmapRenderData.objectsController.objectsList.filter(r=>!(r.obj instanceof Spinner)).map(r=>r.obj.time)}i.key==="Escape"&&(selectedHitObject=[],document.querySelector(".seekTo").open&&closePopup())},urlParams.get("b")===currentMapId&&urlParams.get("t")&&/[0-9]+/g.test(urlParams.get("t"))&&updateTime(parseInt(urlParams.get("t")));const s=i=>{if(isDragging&&currentX!==-1&&currentY!==-1&&(draggingEndTime=this.audioNode.getCurrentTime(),handleCanvasDrag()),!i.ctrlKey){i.deltaY>0&&ot(i.shiftKey,!0),i.deltaY<0&&ot(i.shiftKey,!1);return}i.preventDefault(),i.deltaY>0&&(document.querySelector("#beat").value=Math.max(parseInt(document.querySelector("#beat").value)-1,1)),i.deltaY<0&&(document.querySelector("#beat").value=Math.min(parseInt(document.querySelector("#beat").value)+1,16)),kt(document.querySelector("#beat")),new Notification(`Beatsnap Divisor changed to 1/${document.querySelector("#beat").value}`).notify()};document.querySelector("#playerContainer").addEventListener("wheel",s,{capture:!0,passive:!1}),document.querySelector(".timelineContainer").addEventListener("wheel",s,{capture:!0,passive:!1}),this.isLoaded=!0}catch(t){new Notification(t).notify(),console.error(t),document.querySelector(".loading").style.opacity=0,document.querySelector(".loading").style.display="none",beatmapFile=void 0}}}document.querySelector("#mapInput").onkeydown=ne;function ne(l){l.key==="Enter"&&(Et(!1),document.querySelector("#mapInput").blur())}document.querySelector("#map-dropper").onchange=()=>{const l=document.querySelector("#map-dropper").files[0];if(["osz","osr","osk"].includes(l.name.split(".").at(-1))){if(ScoreParser.reset(),l.name.split(".").at(-1)==="osr"){new ScoreParser(l).getReplayData();return}if(l.name.split(".").at(-1)==="osk"){L.import(l);return}document.querySelector("#close").disabled=!0,Ft(l)}};document.querySelector("#choose-diff").onclick=()=>{document.querySelector(".difficultySelector").style.display="block"};document.querySelector("#close").onclick=()=>{document.querySelector(".difficultySelector").style.display="none"};function oe(){diffFileName=this.dataset.filename,document.querySelector(".difficultySelector").style.display="none",Et(!0)}async function Ft(l){var c,a;dropBlob=null,diffFileName="";const t=l,e=new zip.BlobReader(t),s=new zip.ZipReader(e),i=await s.getEntries(),r=document.querySelector(".difficultyList");r.innerHTML="",document.querySelector(".difficultySelector").style.display="block";const n=[];for(const d of i){if(d.filename.split(".").at(-1)!=="osu")continue;const f=await(await d.getData(new zip.BlobWriter("text/plain"))).text(),m=(c=f.split(`\r
`).filter(w=>/Mode:\s[0-9]+/g.test(w)).at(0))==null?void 0:c.replace("Mode: ","");if(parseInt(m)!==0)continue;const h={addStacking:!0,mods:[]},g=osuPerformance.parseBlueprint(f),b=osuPerformance.buildBeatmap(g,h),p=osuPerformance.calculateDifficultyAttributes(b,!0)[0],A=(a=f.split(`\r
`).filter(w=>/Version:.+/g.test(w)).at(0))==null?void 0:a.replace("Version:",""),O=createDifficultyElement({name:A,fileName:d.filename,starRating:p.starRating});n.push(O)}n.sort((d,u)=>-d.starRating+u.starRating);for(const d of n)r.appendChild(d.ele);dropBlob=l,s.close()}function Et(l,t){var r;window.cancelAnimationFrame(z.requestID);const e=t??document.querySelector("#mapInput").value.trim();if(!l&&!/^https:\/\/osu\.ppy\.sh\/(beatmapsets\/[0-9]+\#osu\/[0-9]+|b\/[0-9]+)|[0-9]+$/.test(e)){document.querySelector("#mapInput").value="",alert("This is not a valid URL or Beatmap ID");return}document.querySelector("audio")&&(document.querySelector("audio").pause(),document.body.removeChild(document.querySelector("audio")));const s=e.split("/").at(-1);beatmapFile!==void 0&&((r=beatmapFile.audioNode)==null||r.pause());const i=window.location.origin;l||window.history.pushState({},"JoSu!",`${i}${i.includes("github.io")?"/beatmap-viewer-web":""}/?b=${s}`),beatmapFile=void 0,beatmapFile=new Nt(s??-1,l),document.querySelector("#mapInput").value=l?"":s}document.querySelector("#submit").addEventListener("click",()=>{Et(!1)});class V{static initLine(){this.line=new PIXI.Graphics().lineStyle({width:4*window.devicePixelRatio,cap:"round",align:0,color:8962256}).moveTo(0,this.HEIGHT/2).lineTo(this.WIDTH-80*window.devicePixelRatio,this.HEIGHT/2)}static initThumb(){this.thumb=new PIXI.Graphics().lineStyle({width:4*window.devicePixelRatio,cap:"round",alignment:1,color:8962256}).beginFill(1514015).drawRoundedRect(-20*window.devicePixelRatio,-5*window.devicePixelRatio,40*window.devicePixelRatio,10*window.devicePixelRatio,10*window.devicePixelRatio).endFill(),this.thumb.y=this.HEIGHT/2,this.thumb.interactive=!0,this.thumb.on("mouseenter",t=>{this.restyle(!0)}),this.thumb.on("mouseleave",t=>{this.IS_DRAGGING||this.restyle()})}static initContainer(){this.container=new PIXI.Container,this.container.addChild(this.line),this.container.addChild(this.thumb),this.container.x=40*window.devicePixelRatio,this.container.hitArea=new PIXI.Rectangle(-40*window.devicePixelRatio,0,this.WIDTH,this.HEIGHT),this.container.interactive=!0,this.container.on("mousedown",t=>{this.handleMouseDown(t)}),this.container.on("mousemove",t=>{this.handleMouseMove(t)}),this.container.on("mouseup",t=>{this.handleMouseUp(t)}),this.container.on("mouseleave",t=>{this.IS_DRAGGING&&this.handleMouseUp(t)}),this.container.on("touchstart",t=>{this.handleMouseDown(t)}),this.container.on("touchmove",t=>{this.handleMouseMove(t)}),this.container.on("touchend",t=>{this.handleMouseUp(t)}),this.stage.addChild(this.container)}static initTimingPoints(){this.timeline.removeChildren().forEach(r=>r.destroy()),this.timelineObjs=[];const e=beatmapFile.audioNode.duration,s=this.WIDTH-80*window.devicePixelRatio,i=this.HEIGHT/2-10*devicePixelRatio;I.mergedPoints.forEach(r=>{const n=r.time/e*s,c=new PIXI.Graphics().lineStyle({width:1,color:r.beatstep?16073306:4388192}).moveTo(n,0).lineTo(n,i);c.alpha=.5,this.timelineObjs.push(c)}),this.timeline.addChild(...this.timelineObjs)}static repositionTimingPoints(){if(!(beatmapFile!=null&&beatmapFile.audioNode))return;const t=beatmapFile.audioNode.duration,e=this.WIDTH-80*window.devicePixelRatio,s=this.HEIGHT/2-10*devicePixelRatio;I.mergedPoints.forEach((i,r)=>{const n=i.time/t*e;this.timelineObjs[r].clear().lineStyle({width:1,color:i.beatstep?16073306:4388192}).moveTo(n,0).lineTo(n,s)})}static init(){const{width:t,height:e}=getComputedStyle(document.querySelector(".progressBarContainer"));this.WIDTH=parseInt(t)*window.devicePixelRatio,this.HEIGHT=parseInt(e)*window.devicePixelRatio,this.renderer=new PIXI.Renderer({width:this.WIDTH,height:this.HEIGHT,backgroundColor:5002858,backgroundAlpha:0,antialias:!0,autoDensity:!0}),document.querySelector(".progressBarContainer").append(this.renderer.view),this.renderer.view.style.transform=`scale(${1/window.devicePixelRatio})`,this.stage=new PIXI.Container,this.timeline=new PIXI.Container,this.timeline.x=40*devicePixelRatio,this.timeline.y=10*devicePixelRatio,this.stage.addChild(this.timeline),this.initLine(),this.initThumb(),this.initContainer()}static handleMouseDown(t){this.IS_DRAGGING=!0;let{x:e}=this.container.toLocal(t.global),s=this.WIDTH-80*window.devicePixelRatio;const i=k(e/s,0,1);Ht(i),this.restyle(!0)}static handleMouseMove(t){if(!this.IS_DRAGGING)return;let{x:e}=this.container.toLocal(t.global),s=this.WIDTH-80*window.devicePixelRatio;const i=k(e/s,0,1);Ht(i)}static handleMouseUp(t){this.IS_DRAGGING=!1,this.restyle()}static resize(){let{width:t,height:e}=getComputedStyle(document.querySelector(".progressBarContainer"));t=parseInt(t)*window.devicePixelRatio,e=parseInt(e)*window.devicePixelRatio,t===0&&(t=parseInt(getComputedStyle(document.querySelector("body")).width)*window.devicePixelRatio),!(this.WIDTH===t&&this.HEIGHT===e)&&(this.WIDTH=t,this.HEIGHT=e,this.renderer.resize(this.WIDTH,this.HEIGHT),this.renderer.view.style.transform=`scale(${1/window.devicePixelRatio})`,this.restyle(),this.timeline.x=40*devicePixelRatio,this.timeline.y=10*devicePixelRatio,this.repositionTimingPoints(),this.thumb.y=this.HEIGHT/2,this.container.x=40*window.devicePixelRatio,this.container.hitArea=new PIXI.Rectangle(-40*window.devicePixelRatio,0,this.WIDTH,this.HEIGHT))}static restyle(t){const e=document.querySelector(":root");let s=parseInt(e.style.getPropertyValue("--primary-1").slice(1),16),i=parseInt(e.style.getPropertyValue("--accent-1").slice(1),16);s||(s=1514015),i||(i=8962256),this.line.clear().lineStyle({width:4*window.devicePixelRatio,cap:"round",align:0,color:i}).moveTo(0,this.HEIGHT/2).lineTo(this.WIDTH-80*window.devicePixelRatio,this.HEIGHT/2),this.thumb.clear().lineStyle({width:4*window.devicePixelRatio,cap:"round",alignment:1,color:i}).beginFill(t?i:s).drawRoundedRect(-20*window.devicePixelRatio,-5*window.devicePixelRatio,40*window.devicePixelRatio,10*window.devicePixelRatio,10*window.devicePixelRatio).endFill()}static update(t){var e,s;this.resize(),(e=beatmapFile==null?void 0:beatmapFile.audioNode)!=null&&e.buf&&(this.thumb.x=t/(((s=beatmapFile==null?void 0:beatmapFile.audioNode)==null?void 0:s.buf.duration)*1e3)*(this.WIDTH-80*window.devicePixelRatio)),this.renderer.render(this.stage)}}o(V,"renderer"),o(V,"stage"),o(V,"container"),o(V,"line"),o(V,"thumb"),o(V,"timeline"),o(V,"timelineObjs",[]),o(V,"WIDTH"),o(V,"HEIGHT"),o(V,"PERCENTAGE",0),o(V,"IS_DRAGGING",!1),o(V,"IS_HOVERING",!1);async function ae(){if(await Database.removeFromObjStore(this.parentElement.dataset.customIndex),L.SKIN_IDX==this.parentElement.dataset.customIndex){const l=JSON.parse(localStorage.getItem("settings"));l.skinning.type="2",l.skinning.val=-1,localStorage.setItem("settings",JSON.stringify(l))}delete L.SKIN_LIST[this.parentElement.dataset.customIndex],L.changeSkin(),delete D.CUSTOM[this.parentElement.dataset.customIndex],delete q.SAMPLES.CUSTOM[this.parentElement.dataset.customIndex],document.querySelector("#skinDropdown").close(),document.querySelector("#skinDropdown").style.display="",await Lt()}function Gt(){const l=L.SKIN_ENUM[this.parentElement.dataset.skinId.toUpperCase()],t=JSON.parse(localStorage.getItem("settings"));t.skinning.type=l,t.skinning.val=this.parentElement.dataset.customIndex,localStorage.setItem("settings",JSON.stringify(t)),skinning.type=l,this.parentElement.dataset.skinId==="custom"&&(L.SKIN_IDX=this.parentElement.dataset.customIndex),L.changeSkin(),document.querySelector("#skinDropdown").close(),document.querySelector("#skinDropdown").style.display=""}async function Lt(){const l=await Database.readObjStore("skins"),t=await Database.getAllKeys();[...document.querySelectorAll('[data-skin-id="custom"]')].forEach(s=>s.remove());const e=document.querySelector("#skinDropdown");for(const[s,i]of l.entries()){const r=t[s],{ini:n,base64s:c,samples:a}=i,d=document.createElement("div");d.classList.add("skinSelection"),d.dataset.skinId="custom",d.dataset.customIndex=r;const u=document.createElement("button");u.classList.add("skinName"),u.textContent=n.NAME,u.onclick=Gt;const f=document.createElement("button");f.classList.add("deleteButton"),f.innerHTML='<img width="18" height="18" src="https://img.icons8.com/material-rounded/24/ffffff/delete-forever.png" alt="delete-forever"/>',f.onclick=ae,d.appendChild(u),d.appendChild(f),e.appendChild(d),["HIT_CIRCLE","HIT_CIRCLE_OVERLAY","SLIDER_B","REVERSE_ARROW","DEFAULTS","SLIDER_FOLLOW_CIRCLE","APPROACH_CIRCLE"].forEach(m=>{if(!c[m])return;if(m==="DEFAULTS"){D.updateNumberTextures(c[m],r);return}const{base64:h,isHD:g}=c[m];D.updateTextureFor(m,h,g,r)}),await L.loadHitsounds(a,r)}L.SKIN_LIST=l.reduce((s,i,r)=>(s[t[r]]=i,s),{})}async function le(){if(document.querySelector("#loadingText").textContent="Initializing: Default Samples",await he(),document.querySelector("#loadingText").textContent="Initializing: Default Skins",await Database.initDatabase(),await Lt(),localStorage.getItem("settings")){const l=JSON.parse(localStorage.getItem("settings"));[...document.querySelectorAll('[name="mirror"]')].forEach(t=>{t.checked=t.value===l.mirror.val}),L.SKIN_IDX=l.skinning.val,L.changeSkin(),document.querySelector("#custom-mirror").value=l.mirror.custom,document.querySelector("#dim").value=l.background.dim,document.querySelector("#bgDimVal").innerHTML=`${parseInt(l.background.dim*100)}%`,document.querySelector("#overlay").style.backgroundColor=`rgba(0 0 0 / ${l.background.dim})`,document.querySelector("#master").value=l.volume.master,document.querySelector("#masterVal").innerHTML=`${parseInt(l.volume.master*100)}%`,document.querySelector("#music").value=l.volume.music,document.querySelector("#musicVal").innerHTML=`${parseInt(l.volume.music*100)}%`,document.querySelector("#effect").value=l.volume.hs,document.querySelector("#effectVal").innerHTML=`${parseInt(l.volume.hs/.4*100)}%`,document.querySelector("#softoffset").value=l.mapping.offset,document.querySelector("#softoffsetVal").innerHTML=`${parseInt(l.mapping.offset)}ms`,Object.keys(l.sliderAppearance).forEach(t=>{["snaking","hitAnim","ignoreSkin"].includes(t)&&(document.querySelector(`#${t}`).checked=l.sliderAppearance[t])}),document.querySelector("#beat").value=l.mapping.beatsnap,document.querySelector("#beatVal").innerHTML=`1/${l.mapping.beatsnap}`,T.SHOW_GREENLINE=l.mapping.showGreenLine,T.ZOOM_DISTANCE=l.timeline.zoomRate,T.SHOW_GREENLINE?document.querySelector(".timeline").style.height="":document.querySelector(".timelineContainer").style.height="60px"}}function k(l,t,e){return Math.max(Math.min(l,e),t)}const ce=d3.scaleLinear().domain([.1,1.25,2,2.5,3.3,4.2,4.9,5.8,6.7,7.7,9]).clamp(!0).range(["#4290FB","#4FC0FF","#4FFFD5","#7CFF4F","#F6F05C","#FF8068","#FF4E6F","#C645B8","#6563DE","#18158E","#000000"]).interpolate(d3.interpolateRgb.gamma(2.2)),xt=l=>l<.1?"#AAAAAA":l>=9?"#000000":ce(l),de=l=>{const t=document.createElement("div");t.classList.add("diff");const e=document.createElement("div");e.classList.add("icon");const s=document.createElement("div");s.classList.add("colorRing"),s.style.border=`solid 4px ${xt(l.starRating)}`,e.append(s);const i=document.createElement("div");i.classList.add("infoContainer");const r=document.createElement("div");r.classList.add("diffName");const n=document.createElement("div");return n.classList.add("starRating"),r.textContent=l.name,n.textContent=`Star Rating: ${l.starRating.toFixed(2)}★`,i.append(r,n),t.append(e,i),t.dataset.filename=l.fileName,t.dataset.starrating=l.starRating,t.onclick=oe,{...l,ele:t}},et=l=>Math.round((l+Number.EPSILON)*100)/100,wt=l=>{var n,c,a,d,u;const e=new Vibrant(l).swatches(),s=document.querySelector(":root"),i=((n=e.DarkMuted)==null?void 0:n.getRgb())??((c=e.DarkVibrant)==null?void 0:c.getRgb());if(i){const f=d3.color(`rgb(${parseInt(i[0])}, ${parseInt(i[1])}, ${parseInt(i[2])})`);[f.darker(2).formatHex(),f.darker(1.5).formatHex(),f.darker(1).formatHex(),f.darker(.5).formatHex(),f.formatHex()].forEach((h,g)=>{s.style.setProperty(`--primary-${g+1}`,h)}),rt.renderer.background.color=parseInt(s.style.getPropertyValue("--primary-5").slice(1),16),V.renderer.background.color=parseInt(s.style.getPropertyValue("--primary-1").slice(1),16)}const r=((a=e.LightVibrant)==null?void 0:a.getRgb())??((d=e.LightMuted)==null?void 0:d.getRgb())??((u=e.Vibrant)==null?void 0:u.getRgb());if(r){const f=d3.color(`rgb(${parseInt(r[0])}, ${parseInt(r[1])}, ${parseInt(r[2])})`);s.style.setProperty("--accent-1",f.formatHex())}V.restyle()};async function he(){for(const l of["ARGON","LEGACY"])for(const t of["normal","soft","drum"])for(const e of["hitnormal","hitwhistle","hitfinish","hitclap","slidertick","sliderwhistle","sliderslide"]){const s=(await axios.get(`./static/${l.toLowerCase()}/${t}-${e}.wav`,{responseType:"arraybuffer"})).data,i=await audioCtx.decodeAudioData(s);q.SAMPLES[l][`${t}-${e}`]=i,q.DEFAULT_SAMPLES[l][`${t}-${e}`]=i}}async function ue(l,t,e){try{if(!e){q.SAMPLES.MAP[`${l}${t}`]=null;return}const s=await audioCtx.decodeAudioData(e);q.SAMPLES.MAP[`${l}${t}`]=s}catch{console.log(`Unable to decode ${l}${t}`)}}function qt(l,t){T.ZOOM_DISTANCE=k(T.ZOOM_DISTANCE+l*20,20,800);const e=JSON.parse(localStorage.getItem("settings"));e.timeline.zoomRate=T.ZOOM_DISTANCE,localStorage.setItem("settings",JSON.stringify(e)),t.blur()}document.querySelector(".zoom .plus").onclick=()=>{qt(1,document.querySelector(".zoom .plus"))};document.querySelector(".zoom .minus").onclick=()=>{qt(-1,document.querySelector(".zoom .minus"))};const yt=(l,t,e)=>{let s=0,i=l.length-1;for(;i>=s;){const r=s+Math.floor((i-s)/2);if(e(l[r],t)===0)return r;if(e(l[r],t)<0){s=r+1;continue}e(l[r],t)>0&&(i=r-1)}return-1},St=(l,t,e)=>{let s=0,i=l.length-1,r=s+Math.floor((i-s)/2);for(;i>=s;){if(r=s+Math.floor((i-s)/2),e(l[r],t)===0)return r;if(e(l[r],t)<0){s=r+1;continue}e(l[r],t)>0&&(i=r-1)}return r},it=(l,t)=>Math.round(l*10**t)/10**t,ht=l=>1-Math.pow(1-l,5),ut=l=>Math.sin(l*Math.PI/2),me=l=>{const t=2*Math.PI/3;return l===0?0:l===1?1:Math.pow(2,-10*l)*Math.sin((l*10-.75)*t)+1};class fe{constructor(t){o(this,"obj");o(this,"hitCircle");this.hitCircle=t;const e=new PIXI.Sprite(D.ARGON.APPROACH_CIRCLE.texture);e.anchor.set(.5),this.obj=e}draw(t){const e=L.SKIN_ENUM[skinning.type],s=e!=="CUSTOM"?D[e]:D.CUSTOM[L.SKIN_IDX],i=s.APPROACH_CIRCLE.isHD?.5:1;this.obj.texture=s.APPROACH_CIRCLE.texture;const r=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,n=sliderAppearance.ignoreSkin?this.hitCircle.colourIdx:this.hitCircle.colourHaxedIdx;this.obj.tint=r[n%r.length];let c=1;if(t<=this.hitCircle.time){const m=(t-(this.hitCircle.time-I.moddedStats.preempt))/I.moddedStats.preempt;c=Math.max(-3*Math.min(m,1)+4,1)}const a=this.hitCircle.originalX,d=mods.HR?384-this.hitCircle.originalY:this.hitCircle.originalY,u=this.hitCircle.stackHeight*I.moddedStats.stackOffset;this.obj.x=(a+u)*y.SCALE_RATE,this.obj.y=(d+u)*y.SCALE_RATE;const f=I.moddedStats.radius/54.4;this.obj.scale.set(i*c*y.SCALE_RATE*f*(236/256)**2*(e==="ARGON"?.95:1)),this.obj.alpha=this.hitCircle.opacity,(mods.HD||t>this.hitCircle.time)&&(this.obj.alpha=0)}}class Xt{constructor(t){o(this,"obj");o(this,"hitObject");this.hitObject=t,this.obj=new PIXI.Container}draw(t){this.obj.removeChildren().forEach(i=>i.destroy());let s=null;this.hitObject.comboIdx.toString().split("").forEach((i,r)=>{const n=L.SKIN_ENUM[skinning.type],c=n!=="CUSTOM"?D[n]:D.CUSTOM[L.SKIN_IDX],a=new PIXI.Sprite(c.DEFAULTS[i].texture);if(a.scale.set(c.DEFAULTS[i].isHD?.5*.8:.8),a.anchor.set(.5),s){const d=n==="ARGON"?L.HIT_CIRCLE_OVERLAP_ARGON:n==="LEGACY"?L.HIT_CIRCLE_OVERLAP:L.SKIN_LIST[L.SKIN_IDX].ini.HIT_CIRCLE_OVERLAP;a.x=s.x+s.width/2+a.width/2-d*.8}s=a,this.obj.addChild(a)}),this.obj.alpha=1,this.obj.x=-s.x/2,t>this.hitObject.hitTime+1&&sliderAppearance.hitAnim&&(this.obj.alpha=0)}}class at{constructor(t,e,s,i){o(this,"startTime");o(this,"hitTime");o(this,"endTime");o(this,"killTime");o(this,"positionX");o(this,"positionY");o(this,"originalX");o(this,"originalY");o(this,"stackHeight",0);o(this,"time");o(this,"obj");o(this,"selected");o(this,"judgementObj");o(this,"hitCircleSprite");o(this,"hitCircleOverlaySprite");o(this,"number");o(this,"approachCircleObj");o(this,"comboIdx",1);o(this,"colourIdx",1);o(this,"colourHaxedIdx",1);o(this,"opacity",0);o(this,"hitSounds");this.originalX=parseInt(t),this.originalY=parseInt(e),this.time=s,this.endTime=s,this.hitTime=s,this.startTime=s-I.stats.preempt,this.killTime=s+240;const r=new PIXI.Sprite(D.SELECTED.texture);r.anchor.set(.5),this.selected=r;const n=new PIXI.Sprite(D.ARGON.HIT_CIRCLE_OVERLAY.texture);n.anchor.set(.5),n.scale.set(D.ARGON.HIT_CIRCLE_OVERLAY.isHD?.5:1),this.hitCircleOverlaySprite=n;const c=new PIXI.Sprite(D.ARGON.HIT_CIRCLE.texture);c.anchor.set(.5),c.scale.set(D.ARGON.HIT_CIRCLE.isHD?.5:1),this.hitCircleSprite=c,this.number=new Xt(this);const a=new PIXI.Container;a.addChild(c),a.addChild(n),a.addChild(this.number.obj),a.x=this.originalX*y.WIDTH/512,a.y=this.originalY*y.WIDTH/512,this.approachCircleObj=new fe(this),this.obj=a,this.hitSounds=i}drawSelected(){const t=I.moddedStats.radius/54.4,e=this.stackHeight,s=I.moddedStats.stackOffset,i=this.originalX+e*s,r=mods.HR?384-this.originalY+e*s:this.originalY+e*s;this.selected.x=i*y.SCALE_RATE,this.selected.y=r*y.SCALE_RATE,this.selected.scale.set(t*y.SCALE_RATE*(236/256)**2)}playHitsound(t){if(this.hitSounds&&beatmapFile.audioNode.isPlaying&&!(t<this.hitTime||z.lastTimestamp>=this.hitTime)&&!ScoreParser.REPLAY_DATA){this.hitSounds.play();return}}draw(t){const e=L.SKIN_ENUM[skinning.type],s=e!=="CUSTOM"?D[e]:D.CUSTOM[L.SKIN_IDX];this.hitCircleSprite.texture=s.HIT_CIRCLE.texture,this.hitCircleSprite.scale.set(s.HIT_CIRCLE.isHD?.5:1),this.hitCircleOverlaySprite.texture=s.HIT_CIRCLE_OVERLAY.texture,this.hitCircleOverlaySprite.scale.set(s.HIT_CIRCLE_OVERLAY.isHD?.5:1);const i=I.moddedStats.radius/54.4*(e==="ARGON"?.95:1),r=I.moddedStats.preempt,n=I.moddedStats.fadeIn,c=sliderAppearance.hitAnim?240:800;let a=0;mods.HD?t<this.time-r+n?a=(t-(this.time-r))/n:a=1-(t-(this.time-r+n))/(r*.3):t<this.hitTime?a=(t-(this.time-r))/n:a=1-(t-this.hitTime)/c,a=k(a,0,1),this.opacity=a,this.hitTime>this.killTime&&t>this.killTime&&(a=0);let d=1;sliderAppearance.hitAnim&&t>this.hitTime&&(d=.5*k((t-this.hitTime)/240,0,1)+1),d=Math.max(d,1);const u=this.stackHeight,f=I.moddedStats.stackOffset;if(sliderAppearance.hitAnim||t<this.hitTime){const g=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,b=sliderAppearance.ignoreSkin?this.colourIdx:this.colourHaxedIdx,p=g[b%g.length];this.hitCircleSprite.tint=p,skinning.type==="1"&&(this.hitCircleSprite.tint=parseInt(d3.color(`#${p.toString(16).padStart(6,"0")}`).darker().hex().slice(1),16))}else this.hitCircleSprite.tint=16777215;this.obj.alpha=a,this.obj.scale.set(d*i*y.SCALE_RATE*(236/256)**2);const m=this.originalX+u*f,h=mods.HR?384-this.originalY+u*f:this.originalY+u*f;this.obj.x=m*y.SCALE_RATE,this.obj.y=h*y.SCALE_RATE,skinning.type!=="0"?this.hitCircleSprite.alpha=.9:this.hitCircleSprite.alpha=1,this.number.draw(t),this.approachCircleObj.draw(t),V.IS_DRAGGING||this.playHitsound(t)}eval(t){var d,u;const e=I.moddedStats.radius,s=ScoreParser.CURSOR_DATA[t];if(!s||s.time-this.time<=-I.hitWindows.MEH)return null;if(s.time-this.time>=I.hitWindows.MEH)return{val:0,valV2:0};if(((d=ScoreParser.EVAL_LIST.at(-1))==null?void 0:d.eval)===0&&Math.abs(s.time-(((u=ScoreParser.EVAL_LIST.at(-1))==null?void 0:u.time)??s.time))<I.hitWindows.MEH)return null;const i=ScoreParser.CURSOR_DATA[t-1];if(s.inputArray.length===0||i.inputArray.length>s.inputArray.length||i.inputArray.length===s.inputArray.length&&JSON.stringify(i.inputArray)===JSON.stringify(s.inputArray))return null;const r=I.moddedStats.stackOffset,n={x:this.stackHeight*r,y:this.stackHeight*r};if(it(Dist(s,mods.HR?Add(FlipHR({x:this.originalX,y:this.originalY}),n):Add({x:this.originalX,y:this.originalY},n))/e,2)>1)return this.hitTime=this.killTime,this.killTime=this.time+I.hitWindows.MEH,null;let c=0;const a=Math.abs(s.time-this.time);return a<I.hitWindows.GREAT&&(c=300),a>=I.hitWindows.GREAT&&a<I.hitWindows.OK&&(c=100),a>=I.hitWindows.OK&&a<I.hitWindows.MEH&&(c=50),c!==0&&(this.hitTime=s.time),{val:c,valV2:c,delta:s.time-this.time,inputTime:s.time}}}const pe=`
precision mediump float;
attribute vec4 position;
varying float dist;
uniform float dx,dy,dt,ox,oy,ot, circleBaseScale;
void main() {
    dist = position[3];
    float test = 0.0;

    if (position[2] * dt > ot)
        test = 1.0;

    gl_Position = vec4(position[0], position[1], position[3] + 2.0 * test, 1.0);
    gl_Position.x = gl_Position.x * dx + ox;
    gl_Position.y = gl_Position.y * dy + oy;
}`,Se=`
precision mediump float;
varying float dist;
uniform sampler2D uSampler2;
uniform float alpha;
uniform float texturepos;
uniform vec4 tint;
uniform bool select;
uniform float circleBaseScale;
uniform vec4 sliderBorder;
uniform vec4 sliderTrackOverride;
uniform float skinning;

vec4 lighten(vec4 color, float amount) {
    amount *= 0.5;
    color.r = min(1.0, color.r * (1.0 + 0.5 * amount) + 1.0 * amount);
    color.g = min(1.0, color.g * (1.0 + 0.5 * amount) + 1.0 * amount);
    color.b = min(1.0, color.b * (1.0 + 0.5 * amount) + 1.0 * amount);

    return color;
}

vec4 darken(vec4 color, float amount) {
    float scalar = max(1.0, 1.0 + amount);
    color.r = min(1.0, color.r / scalar);
    color.g = min(1.0, color.g / scalar);
    color.b = min(1.0, color.b / scalar);
    return color;
}

void main() {
    float borderWidth = 0.128;
    float a = 1.0;

    if (skinning == 0.0 && !select) borderWidth *= 1.65;

    float innerWidth = 1.0 - borderWidth;
    float outBlurRate = 0.03;
    float inBlurRate = 0.03;

    vec4 borderColor = sliderBorder;

    vec4 baseColor = texture2D(uSampler2, vec2(dist, texturepos));
    vec4 color_mixed = sliderTrackOverride;

    if (skinning != 2.0 && skinning != 3.0 && skinning != 4.0) color_mixed = tint;

    float scale = circleBaseScale;
    if (skinning == 0.0 && !select) scale *= 0.95;

    float position = vec2(dist, texturepos).x / scale;

    vec4 outerColor = darken(color_mixed, 0.1);
    vec4 innerColor = lighten(color_mixed, 0.5);

    if (skinning == 1.0) {
        outerColor = darken(color_mixed, 2.0);
        innerColor = darken(color_mixed, 0.5);
    }
    
    vec4 color = mix(innerColor, outerColor, position);
    if (skinning == 3.0) color = mix(outerColor, innerColor, position);
    if ((skinning != 2.0 && skinning != 3.0 && skinning != 4.0) || select) borderColor = tint;
    if (skinning == 0.0) color = darken(color_mixed, 4.0);

    // Anti-aliasing at outer edge
    if (1.0 - position < outBlurRate) {
        color = borderColor * (1.0 - position) / outBlurRate;
        a = (1.0 - position) / outBlurRate; 
    }

    // Set border color
    if (position >= innerWidth + inBlurRate) {
        color = borderColor;
    }

    // Anti-aliasing at inner edge
    if (position >= innerWidth && position < innerWidth + inBlurRate) {
        float mu = (position - innerWidth) / inBlurRate;
        color = borderColor * mu + (1.0 - mu) * color;

        a = 1.0;
        if (skinning != 0.0) a = 1.0 * mu + (1.0 - mu) * 0.7;
        if (select) a = 1.0 * mu + (1.0 - mu) * 0.0;
        
    }

    // Set body color
    if (position < innerWidth) {
        if (skinning != 0.0) a = 0.7;
        if (select) a = 0.0;
    }

    color.a = 1.0;

    gl_FragColor = min(alpha * a, 1.0) * color;
}`;function Pt(){let t=new Uint8Array(1600);for(let e=0;e<400;e++)t[e*4]=0,t[e*4+1]=0,t[e*4+2]=0,t[e*4+3]=1;return PIXI.Texture.fromBuffer(t,400,1)}const mt=64;function ge(l,t){const e=new Array;for(let n=0;n<l.length;++n)(n==0||Math.abs(l[n].x-l[n-1].x)>1e-5||Math.abs(l[n].y-l[n-1].y)>1e-5)&&e.push(l[n]);let s=new Array,i=new Array;s.push(e[0].x,e[0].y,e[0].t,0);for(let n=1;n<e.length;++n){let c=e[n].x,a=e[n].y,d=e[n].t,u=e[n-1].x,f=e[n-1].y,m=e[n-1].t,h=c-u,g=a-f,b=Math.hypot(h,g),p=t*-g/b,A=t*h/b;s.push(u+p,f+A,m,1),s.push(u-p,f-A,m,1),s.push(c+p,a+A,d,1),s.push(c-p,a-A,d,1),s.push(c,a,d,0);let O=5*n+1;i.push(O-6,O-5,O-1,O-5,O-1,O-3),i.push(O-6,O-4,O-1,O-4,O-1,O-2)}function r(n,c,a,d){let u=Math.atan2(s[4*c+1]-s[4*n+1],s[4*c]-s[4*n]),f=Math.atan2(s[4*a+1]-s[4*n+1],s[4*a]-s[4*n]);u>f&&(f+=2*Math.PI);let m=f-u,h=Math.ceil(mt*Math.abs(m)/(2*Math.PI));m/=h;let g=c;for(let b=1;b<h;++b){s.push(s[4*n]+t*Math.cos(u+b*m),s[4*n+1]+t*Math.sin(u+b*m),d,1);let p=s.length/4-1;i.push(n,g,p),g=p}i.push(n,g,a)}r(0,1,2,e[0].t),r(5*e.length-5,5*e.length-6,5*e.length-7,e[e.length-1].t);for(let n=1;n<e.length-1;++n){let c=e[n].x-e[n-1].x,a=e[n].y-e[n-1].y,d=e[n+1].x-e[n].x,u=e[n+1].y-e[n].y;c*u-d*a>0?r(5*n,5*n-1,5*n+2):r(5*n,5*n+1,5*n-2)}return new PIXI.Geometry().addAttribute("position",s,4).addIndex(i)}function Ie(l){let t=new Array,e=new Array;t.push(0,0,0,0);for(let s=0;s<mt;++s){let i=2*Math.PI/mt*s;t.push(l*Math.cos(i),l*Math.sin(i),0,1),e.push(0,s+1,(s+1)%mt+1)}return new PIXI.Geometry().addAttribute("position",t,4).addIndex(e)}class be{constructor(t,e){o(this,"curve");o(this,"geometry");o(this,"sliderContainer");o(this,"selSliderContainer");this.curve=t,this.sliderContainer=new Ot(t,e),this.selSliderContainer=new Ot(t,e)}initiallize(t){this.geometry=ge(this.curve,t),this.circle=Ie(t),this.sliderContainer.initiallize(this.geometry,this.circle,!1),this.selSliderContainer.initiallize(this.geometry,this.circle,!0)}}class Ot extends PIXI.Container{constructor(e,s){super();o(this,"tint",[1,1,1,1]);o(this,"select",!1);this.curve=e,this.alpha=1,this.startt=0,this.endt=1,this.slider=s,this.state=PIXI.State.for2d(),this.drawMode=PIXI.DRAW_MODES.TRIANGLES,this.blendMode=PIXI.BLEND_MODES.NORMAL,this._roundPixels=PIXI.settings.ROUND_PIXELS}initiallize(e,s,i){const r=mods.HR?-1:1,n=I.moddedStats.stackOffset,c=I.moddedStats.radius/54.4,a=2*y.WIDTH/y.APP.view.width/512,d=r*(-2*y.HEIGHT)/y.APP.view.height/384,u={dx:a,ox:-1*(y.WIDTH/y.APP.view.width)+a*this.slider.stackHeight*n,dy:d,oy:r*1*(y.HEIGHT/y.APP.view.height)+r*d*this.slider.stackHeight*n},f=L.SKIN_ENUM[skinning.type];this.ncolors=1,this.uSampler2=SliderTexture,this.select=i,this.circle=s,this.geometry=e,this.uniforms={uSampler2:this.uSampler2,alpha:1,dx:u.dx,dy:u.dy,ox:u.ox,oy:u.oy,texturepos:0,tint:this.tint,select:this.select,circleBaseScale:c,sliderBorder:f==="CUSTOM"?L.SLIDER_BORDER:[1,1,1,1],sliderTrackOverride:f==="CUSTOM"?L.SLIDER_TRACK_OVERRIDE:this.tint??this.tint,skinning:parseFloat(skinning.type)},this.shader=PIXI.Shader.from(pe,Se,this.uniforms)}_render(e){this._renderDefault(e)}_renderDefault(e){const s=mods.HR?-1:1,i=I.moddedStats.stackOffset,r=I.moddedStats.radius/54.4,n=2*y.WIDTH/y.APP.view.width/512,c=s*(-2*y.HEIGHT)/y.APP.view.height/384,a={dx:n,ox:-1*(y.WIDTH/y.APP.view.width)+n*this.slider.stackHeight*i,dy:c,oy:s*1*(y.HEIGHT/y.APP.view.height)+s*c*this.slider.stackHeight*i};var d=this.shader;d.alpha=this.worldAlpha,d.update&&d.update(),e.batch.flush();const u=L.SKIN_ENUM[skinning.type];this.uniforms.alpha=this.alpha,this.uniforms.texturepos=0,this.uniforms.dx=a.dx,this.uniforms.ox=a.ox,this.uniforms.dy=a.dy,this.uniforms.oy=a.oy,this.uniforms.dt=0,this.uniforms.ot=.5,this.uniforms.tint=this.tint,this.uniforms.skinning=parseFloat(skinning.type),this.uniforms.select=this.select,this.uniforms.circleBaseScale=r,this.uniforms.sliderBorder=(u==="CUSTOM"?L.SLIDER_BORDER:[1,1,1,1])??[1,1,1,1],this.uniforms.sliderTrackOverride=(u==="CUSTOM"?L.SLIDER_TRACK_OVERRIDE:this.tint)??this.tint;let f=this.uniforms.ox,m=this.uniforms.oy;const h=e.gl;h.clearDepth(1),h.clear(h.DEPTH_BUFFER_BIT),h.colorMask(!1,!1,!1,!1),e.state.set(this.state),e.state.setDepthTest(!0);let g,b;function p(A){e.shader.bind(d),e.geometry.bind(A,d),g=A.indexBuffer.data.BYTES_PER_ELEMENT===2?h.UNSIGNED_SHORT:h.UNSIGNED_INT,b=A.indexBuffer.data.length}if(this.startt==0&&this.endt==1)this.uniforms.dt=0,this.uniforms.ot=1,p(this.geometry),h.drawElements(this.drawMode,b,g,0);else if(this.endt==1){this.startt!=1&&(this.uniforms.dt=-1,this.uniforms.ot=-this.startt,p(this.geometry),h.drawElements(this.drawMode,b,g,0)),this.uniforms.dt=0,this.uniforms.ot=1;let A=this.curve.find(O=>O.t>=this.startt);this.uniforms.ox+=A.x*this.uniforms.dx,this.uniforms.oy+=A.y*this.uniforms.dy,p(this.circle),h.drawElements(this.drawMode,b,g,0)}else if(this.startt==0){this.endt!=0&&(this.uniforms.dt=1,this.uniforms.ot=this.endt,p(this.geometry),h.drawElements(this.drawMode,b,g,0)),this.uniforms.dt=0,this.uniforms.ot=1;let A=this.curve.findLast(O=>O.t<=this.endt);this.uniforms.ox+=A.x*this.uniforms.dx,this.uniforms.oy+=A.y*this.uniforms.dy,p(this.circle),h.drawElements(this.drawMode,b,g,0)}else console.error("can't snake both end of slider");h.depthFunc(h.EQUAL),h.colorMask(!0,!0,!0,!0),this.startt==0&&this.endt==1?h.drawElements(this.drawMode,b,g,0):this.endt==1?(this.startt!=1&&(h.drawElements(this.drawMode,b,g,0),this.uniforms.ox=f,this.uniforms.oy=m,this.uniforms.dt=-1,this.uniforms.ot=-this.startt,p(this.geometry)),h.drawElements(this.drawMode,b,g,0)):this.startt==0&&(this.endt!=0&&(h.drawElements(this.drawMode,b,g,0),this.uniforms.ox=f,this.uniforms.oy=m,this.uniforms.dt=1,this.uniforms.ot=this.endt,p(this.geometry)),h.drawElements(this.drawMode,b,g,0)),h.depthFunc(h.LESS),e.state.setDepthTest(!1),this.uniforms.ox=f,this.uniforms.oy=m}}class Te{constructor(t){o(this,"baseSlider");o(this,"obj");o(this,"arrow");o(this,"ring");o(this,"bg");o(this,"followCircle");o(this,"sliderB");this.baseSlider=t,this.obj=new PIXI.Container;const e=new PIXI.Sprite(D.ARGON.SLIDER_FOLLOW_CIRCLE.texture),s=new PIXI.Sprite(D.ARGON.SLIDER_B.arrow.texture),i=new PIXI.Sprite(D.ARGON.SLIDER_B.ring.texture),r=new PIXI.Graphics().beginFill(16777215).drawCircle(0,0,59).endFill(),n=new PIXI.Sprite(D.ARGON.SLIDER_B.gradient.texture);n.mask=r,e.anchor.set(.5),s.anchor.set(.5),i.anchor.set(.5),n.anchor.set(.5),i.scale.set(D.ARGON.SLIDER_B.ring.isHD?.5:1);const c=new PIXI.Container;c.addChild(r),c.addChild(n),c.addChild(s),c.addChild(i),this.obj.addChild(e),this.obj.addChild(c),this.arrow=s,this.ring=i,this.bg=n,this.followCircle=e,this.sliderB=c}draw(t){const e=L.SKIN_ENUM[skinning.type],s=e!=="CUSTOM"?D[e]:D.CUSTOM[L.SKIN_IDX],i=I.moddedStats.radius/54.4*(e==="ARGON"?.95:1),r=s.SLIDER_FOLLOW_CIRCLE.isHD?.25:.5;if(this.followCircle.texture=s.SLIDER_FOLLOW_CIRCLE.texture,this.arrow.texture=s.SLIDER_B.arrow.texture,this.ring.texture=s.SLIDER_B.ring.texture,this.bg.texture=s.SLIDER_B.gradient.texture,this.followCircle.scale.set(r),this.ring.scale.set(s.SLIDER_B.ring.isHD?.5:1),this.obj.alpha=1,this.sliderB.alpha=1,this.followCircle.alpha=1,this.followCircle.scale.set(2.4*r),(t<this.baseSlider.time||t>=this.baseSlider.endTime+200)&&(this.obj.alpha=0),t>=this.baseSlider.time&&t<this.baseSlider.time+300){const m=k((t-this.baseSlider.time)/200,0,1),h=k((t-this.baseSlider.time)/150,0,1);this.sliderB.alpha=ht(m),this.followCircle.alpha=ht(h),this.followCircle.scale.set((1.5+h*.9)*r)}this.arrow.scale.set(.7,.8);let n=this.baseSlider.getPointAtTime(t)??this.baseSlider.realTrackPoints.at(-1);t<this.baseSlider.time&&(n=this.baseSlider.realTrackPoints.at(0)),this.arrow.angle=mods.HR?-n.angle:n.angle;const c=I.moddedStats.stackOffset;let{x:a,y:d}=n;mods.HR&&(d=384-d),this.obj.scale.set(i*y.SCALE_RATE*(236/256)**2),this.obj.x=(a+this.baseSlider.stackHeight*c)*(y.WIDTH/512),this.obj.y=(d+this.baseSlider.stackHeight*c)*(y.WIDTH/512);const u=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,f=sliderAppearance.ignoreSkin?this.baseSlider.colourIdx:this.baseSlider.colourHaxedIdx;if(this.bg.tint=u[f%u.length],this.bg.angle=-this.obj.angle,this.followCircle.tint=16777215,e==="ARGON"&&(this.followCircle.tint=u[f%u.length]),t>this.baseSlider.endTime&&t<this.baseSlider.endTime+200){const m=k((t-this.baseSlider.endTime)/200,0,1),h=k((t-this.baseSlider.endTime)/200,0,1);this.sliderB.alpha=1-ht(m),this.followCircle.alpha=1-ht(h),this.followCircle.scale.set((1.5+(1-h)*.9)*r)}}}class ye{constructor(t,e,s,i,r,n){o(this,"baseSlider");o(this,"time");o(this,"willHit",!1);o(this,"idx");o(this,"position");o(this,"angle");o(this,"stackHeight");o(this,"obj");o(this,"ringSprite");o(this,"arrowSprite");o(this,"baseUnit",200/2);this.baseSlider=t,this.time=e,this.position=s,this.angle=i,this.stackHeight=r,this.idx=n;const c=new PIXI.Sprite(D.ARGON.REVERSE_ARROW.arrow.texture);c.anchor.set(.5),this.arrowSprite=c;const a=new PIXI.Sprite(D.ARGON.REVERSE_ARROW.ring.texture);a.anchor.set(.5),a.scale.set(.5*(229/200)),this.ringSprite=a,this.obj=new PIXI.Container,this.obj.addChild(a),this.obj.addChild(c)}calculatePulseAtTime(t){const e=t%300;let s=0;return e<=35&&(s=e/35),e>35&&e<285&&(s=1-(e-35)/250),s}playHitsound(t){if(beatmapFile.audioNode.isPlaying&&!(t<this.time||z.lastTimestamp>=this.time)&&!ScoreParser.REPLAY_DATA){this.baseSlider.hitSounds.sliderReverse[this.idx].play();return}}draw(t){this.playHitsound(t);const e=L.SKIN_ENUM[skinning.type],s=e!=="CUSTOM"?D[e]:D.CUSTOM[L.SKIN_IDX];this.ringSprite.texture=s.REVERSE_ARROW.ring.texture,this.arrowSprite.texture=s.REVERSE_ARROW.arrow.texture;const i=I.moddedStats.stackOffset,r=I.moddedStats.radius/54.4,n=mods.HR?384-this.position.y:this.position.y;this.obj.x=(this.position.x+this.baseSlider.stackHeight*i)*(y.WIDTH/512),this.obj.y=(n+this.baseSlider.stackHeight*i)*(y.WIDTH/512),this.obj.rotation=mods.HR?Math.PI*2-this.angle:this.angle;let c=this.calculatePulseAtTime(t);const a=r*y.SCALE_RATE*(s.REVERSE_ARROW.arrow.isHD?.5:1)*(236/256)**2*(e==="ARGON"?.95:1);if(this.arrowSprite.scale.set(a*(1+ut(c)*.2)),this.ringSprite.scale.set(.5*(229/200)*a),this.ringSprite.x=ut(c)*-12*(512/y.WIDTH),this.obj.scale.set(1),this.obj.alpha=0,this.idx===0&&t<this.baseSlider.time){this.obj.alpha=k((this.baseSlider.opacity-.5)*2,0,1);return}const d=Math.min(300,this.baseSlider.sliderTime);if(this.idx!==0){if(t<this.time-this.baseSlider.sliderTime*2)return;if(t>=this.time-this.baseSlider.sliderTime*2&&t<this.time-this.baseSlider.sliderTime*2+d){this.obj.alpha=(t-(this.time-this.baseSlider.sliderTime*2))/d;return}}if(t<this.time){this.obj.alpha=1;return}if(mods.HD){this.obj.alpha=1,t>this.time&&(this.obj.alpha=0);return}const u=this.baseSlider.endTime-this.baseSlider.time,f=Math.min(300,u);this.arrowSprite.scale.set(a),this.ringSprite.x=0;const m=(t-this.time)/f;this.obj.scale.set(k(ut(m),0,1)*.5+1),this.obj.alpha=k(1-ut(m),0,1),t>this.time+f&&(this.obj.alpha=0)}}class Ce{constructor(t,e,s){o(this,"hitTime",-1);o(this,"info");o(this,"spanIdx");o(this,"obj");o(this,"graphic");o(this,"slider");o(this,"scale");o(this,"hitSound");this.info=t,this.slider=e,this.obj=new PIXI.Container,this.graphic=new PIXI.Graphics().lineStyle({width:3,color:16777215,alpha:1,cap:"round",alignment:0}).drawCircle(0,0,4),this.obj.addChild(this.graphic),this.scale=I.moddedStats.radius/54.4,this.spanIdx=s,this.getHitSound()}getHitSound(){let t=St(I.timingPointsList,this.info.time,(c,a)=>c.time<a?-1:c.time>a?1:0);for(;I.timingPointsList[t].time>this.info.time&&t>0;)t--;const{sampleIdx:e,sampleSet:s,sampleVol:i}=I.timingPointsList[t],r=this.slider.hitSounds.defaultSet.normal;let n=HitSound.HIT_SAMPLES[I.SAMPLE_SET];s!==0&&(n=HitSound.HIT_SAMPLES[s]),r!==0&&(n=HitSound.HIT_SAMPLES[r]),this.hitSound=new q([`${n}-slidertick${e}`],i/100)}playHitsound(t){if(this.hitSound&&beatmapFile.audioNode.isPlaying&&!(t<this.info.time||z.lastTimestamp>=this.info.time)&&!ScoreParser.REPLAY_DATA){this.hitSound.play();return}}draw(t){this.playHitsound(t);const e=L.SKIN_ENUM[skinning.type],s=this.slider.time-I.moddedStats.preempt/2+this.spanIdx*(I.moddedStats.preempt/2/this.slider.sliderParts.filter(d=>d.type==="Slider Tick").length);let i=600;this.info.time-s<i&&(i=this.info.time-s);const r=I.moddedStats.stackOffset,n=I.moddedStats.radius/54.4;let{x:c,y:a}=this.info;if(mods.HR&&(a=384-a),this.obj.x=(c+this.slider.stackHeight*r)*y.SCALE_RATE,this.obj.y=(a+this.slider.stackHeight*r)*y.SCALE_RATE,this.graphic.tint=16777215,e!=="LEGACY"&&e!=="CUSTOM"){const d=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,u=sliderAppearance.ignoreSkin?this.slider.colourIdx:this.slider.colourHaxedIdx,f=d[u%d.length];this.graphic.tint=f}if(t<s){this.obj.alpha=0;return}if(t>=s&&t<s+i){const d=k((t-s)/150,0,1);this.obj.alpha=d;const u=k((t-s)/i,0,1),f=me(u);this.obj.scale.set(n*y.SCALE_RATE*(.5+f*.5));return}this.obj.alpha=1,this.obj.scale.set(n*y.SCALE_RATE),t>this.info.time&&(this.obj.alpha=0)}}class Z{constructor(t,e,s,i,r,n,c,a,d){o(this,"originalArr",[]);o(this,"angleList",[]);o(this,"realTrackPoints");o(this,"sliderParts");o(this,"sliderEndEvalPosition");o(this,"sliderLength");o(this,"svMultiplier");o(this,"baseSV");o(this,"beatStep");o(this,"startTime");o(this,"endTime");o(this,"repeat");o(this,"sliderType");o(this,"stackHeight",0);o(this,"time");o(this,"hitTime");o(this,"SliderMesh");o(this,"SliderSelectedMesh");o(this,"obj");o(this,"selected");o(this,"selectedSliderEnd");o(this,"hitCircle");o(this,"revArrows",[]);o(this,"ticks",[]);o(this,"ball");o(this,"angleE");o(this,"angleS");o(this,"colourIdx",1);o(this,"colourHaxedIdx",1);o(this,"comboIdx",1);o(this,"isHover",!1);o(this,"opacity",0);o(this,"hitSounds");this.sliderType=e;const u=t.split("|").map(h=>({x:h.split(":")[0],y:h.split(":")[1]})),f=[];for(let h=0;h<u.length;h++){if(u[h+1]&&this.Dist(u[h],u[h+1])===0){f.push({type:"Red Anchor",position:u[h]}),h++;continue}f.push({type:"White Anchor",position:u[h]})}if(this.nodes=f,this.originalArr=u,this.sliderLength=s,this.svMultiplier=i,this.repeat=a,this.baseSV=r,this.beatStep=parseFloat(n),this.time=c,this.endTime=c+this.sliderLength*this.repeat/(this.svMultiplier*this.baseSV)*n,this.hitTime=this.time,this.startTime=c-I.stats.preempt,this.killTime=this.endTime+240,this.sliderTime=n*it(this.sliderLength/(this.svMultiplier*this.baseSV),2),this.sliderTicksCount=(Math.ceil(it(this.sliderLength/this.svMultiplier/(r/I.stats.sliderTickRate),1))-1)*this.repeat,this.hitCircle=new at(u[0].x,u[0].y,c),this.hitCircle.hitTime=this.hitTime,this.hitSounds=d,this.angleList=this.getAngleList(u),this.realTrackPoints=[...Array(this.repeat).keys()].reduce((h,g,b)=>{let p=[];return b%2===0&&(p=h.concat(this.angleList.slice(0,-1))),b%2!==0&&(p=h.concat([...this.angleList].reverse().slice(0,-1).map(A=>({...A,angle:A.angle+180})))),b===this.repeat-1&&(b%2===0?p.push(this.angleList.at(-1)):p.push({...this.angleList[0],angle:this.angleList[0].angle+180})),p},[]).map((h,g)=>({...h,t:g/((this.angleList.length-1)*this.repeat+1)})),this.getSliderPart(),this.repeat>1){const h=this.angleList.at(-1).x-this.angleList.at(-2).x,g=this.angleList.at(-1).y-this.angleList.at(-2).y,b=Math.abs(g/h),p=this.angleList[0].x-this.angleList[1].x,A=this.angleList[0].y-this.angleList[1].y,O=Math.abs(A/p);let w=h>=0?Math.atan(b)*180/Math.PI:180-Math.atan(b)*180/Math.PI;w=((g>=0?w:-w)+180)*Math.PI/180;let M=p>=0?Math.atan(O)*180/Math.PI:180-Math.atan(O)*180/Math.PI;M=((A>=0?M:-M)+180)*Math.PI/180,this.angleE=w,this.angleS=M,this.sliderParts.filter(G=>G.type==="Slider Repeat").forEach((G,B)=>{const Y=B%2===0?this.angleE:this.angleS,C=new ye(this,G.time,G,Y,this.stackHeight,B);this.revArrows.push(C)})}this.sliderParts.filter(h=>h.type==="Slider Tick").forEach((h,g)=>{const b=new Ce(h,this,g);this.ticks.push(b)}),this.sliderGeometryContainer=new be(this.angleList,this),this.reInitialize(),this.SliderMesh=this.sliderGeometryContainer.sliderContainer,this.selected=this.sliderGeometryContainer.selSliderContainer,this.SliderMeshContainer=new PIXI.Container,this.SliderMeshContainer.addChild(this.SliderMesh),this.ball=new Te(this);const m=new PIXI.Container;m.addChild(this.SliderMeshContainer),this.revArrows.forEach(h=>m.addChild(h.obj)),this.ticks.forEach(h=>m.addChild(h.obj)),this.nodesContainer=new PIXI.Container,this.nodesLine=new PIXI.Graphics().lineStyle(1,16777215).moveTo(this.nodes[0].position.x,this.nodes[0].position.y),this.nodesGraphics=this.nodes.map(h=>{const g=h.type==="White Anchor"?16777215:16711680,b=h.position.x,p=h.position.y;this.nodesLine.lineTo(b,p);const A=new PIXI.Graphics().lineStyle({width:1,color:0,alpha:1,alignment:0}).beginFill(g).drawRect(-4,-4,8,8).endFill();return this.nodesContainer.addChild(A),A}),this.nodesContainer.addChild(this.nodesLine),this.selectedSliderEnd=new PIXI.Sprite(D.SELECTED.texture),this.selectedSliderEnd.anchor.set(.5),m.addChild(this.ball.obj),m.addChild(this.hitCircle.obj),m.addChild(this.nodesContainer),this.obj=m}binom(t,e){if(e<0||e>t)return 0;if(e==0||e==t)return 1;for(var s=1,i=0;i<e;i++)s=s*(t-i)/(i+1);return s}bezier(t,e){var s=e.length-1,i=0,r=0;for(let n=0;n<=s;n++)r=r+this.binom(s,n)*Math.pow(1-t,s-n)*Math.pow(t,n)*e[n].x,i=i+this.binom(s,n)*Math.pow(1-t,s-n)*Math.pow(t,n)*e[n].y;return{x:r,y:i}}drawSelected(){this.selected.alpha=1,this.selected.tint=Object.values(d3.rgb("#3197ff")).map(n=>n/255),this.hitCircle.drawSelected();const t=I.moddedStats.radius/54.4,e=this.stackHeight,s=I.moddedStats.stackOffset,i=this.sliderEndEvalPosition.x+e*s,r=mods.HR?384-this.sliderEndEvalPosition.y+e*s:this.sliderEndEvalPosition.y+e*s;this.selectedSliderEnd.x=i*y.SCALE_RATE,this.selectedSliderEnd.y=r*y.SCALE_RATE,this.selectedSliderEnd.scale.set(t*y.SCALE_RATE*(236/256)**2)}playHitsound(t){if(this.hitSounds.sliderWhistle.gainNode.gain.value=z.CURRENT_SV.sampleVol/100,this.hitSounds.sliderSlide.gainNode.gain.value=z.CURRENT_SV.sampleVol/100,this.hitSounds.defaultSet.hitSoundIdx!==0&&this.hitSounds.sliderWhistle.playLoop(t>=this.hitTime,t<=this.endTime,this.endTime-t),this.hitSounds.sliderSlide.playLoop(t>=this.hitTime,t<=this.endTime,this.endTime-t),!!beatmapFile.audioNode.isPlaying){if(t>=this.hitTime&&z.lastTimestamp<this.hitTime){if(!ScoreParser.REPLAY_DATA){this.hitSounds.sliderHead.play();return}return}if(t>=this.endTime&&z.lastTimestamp<this.endTime){if(!ScoreParser.REPLAY_DATA){this.hitSounds.sliderTail.play();return}return}}}drawBorder(t){const e=I.moddedStats.stackOffset,s=I.moddedStats.preempt,i=I.moddedStats.fadeIn,r=240;let n=0;mods.HD?(n=1-(t-this.time)/(this.endTime-this.time),t<this.time&&(n=(t-(this.time-s))/i)):(n=1,t<this.time&&(n=(t-(this.time-s))/i),t>this.endTime&&(n=1-(t-this.endTime)/r,sliderAppearance.snaking&&this.hitTime<=this.killTime&&(n=0))),n=k(n,0,1),this.opacity=n,this.SliderMesh.alpha=n;const c=k((t-this.time)/(this.endTime-this.time),0,1);sliderAppearance.snaking?t<this.hitTime?(this.SliderMesh.startt=0,this.SliderMesh.endt=k(n*2,0,1),this.hitTime>this.endTime&&(this.SliderMesh.endt=1)):t>=this.hitTime&&(this.repeat%2===0?(this.SliderMesh.startt=0,this.SliderMesh.endt=1-k((c-1)*this.repeat+1,0,1)):(this.SliderMesh.startt=k((c-1)*this.repeat+1,0,1),this.SliderMesh.endt=1)):(this.SliderMesh.startt=0,this.SliderMesh.endt=1);const a=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,d=sliderAppearance.ignoreSkin?this.colourIdx:this.colourHaxedIdx;this.SliderMesh.tintid=0,this.SliderMesh.tint=Object.values(d3.rgb(`#${a[d%a.length].toString(16).padStart(6,"0")}`)).map(u=>u/255),this.nodesLine.clear().lineStyle(1,16777215),this.nodesGraphics.forEach((u,f)=>{let{x:m,y:h}=this.nodes[f].position;if(mods.HR&&(h=384-h),m=(parseInt(m)+this.stackHeight*e)*y.SCALE_RATE,h=(parseInt(h)+this.stackHeight*e)*y.SCALE_RATE,u.x=m,u.y=h,f===0){this.nodesLine.moveTo(m,h);return}this.nodesLine.lineTo(m,h)}),this.isHover?this.nodesContainer.visible=!0:this.nodesContainer.visible=!1}draw(t){this.drawBorder(t),this.hitCircle.draw(t),this.revArrows.forEach(e=>e.draw(t)),this.ticks.forEach(e=>e.draw(t)),this.ball.draw(t),V.IS_DRAGGING||this.playHitsound(t)}reInitialize(){this.sliderGeometryContainer.initiallize(54.4*(236/256))}createEquiDistCurve(t,e,s){let i=t;const r=e*Math.max(1/this.sliderLength,y.SLIDER_ACCURACY);for(let n=0;n<i.length-1;n++){let c=this.Dist(i[n],i[n+1]);for(;c<r&&n+1<i.length-1;)i.splice(n+1,1),c=this.Dist(i[n],i[n+1]);if(c>r){const a=[];for(let d=0;d<1;d+=r/c){if(d===0)continue;const u=i[n].x+(i[n+1].x-i[n].x)*r/c,f=i[n].y+(i[n+1].y-i[n].y)*r/c;a.push({x:u,y:f})}i=i.slice(0,n+1).concat(a).concat(i.slice(n+1))}}return i}Dist(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}generatePointsList(t){let e=[];for(let r=0;r<1;r+=Math.max(1/this.sliderLength,y.SLIDER_ACCURACY))e.push(this.bezier(r,t));let s=0;for(let r=0;r<e.length-1;r++)s+=this.Dist(e[r],e[r+1]);e=this.createEquiDistCurve(e,this.sliderLength,s);let i=0;for(let r=0;r<e.length-1;r++)i+=this.Dist(e[r],e[r+1]);return e=e.map((r,n)=>({...r,t:n/(e.length-1)})),{points:e,length:i}}getCirclePoints(t){let e,s,i,r,n,c,a,d,u,f,m,h,g,b;e=Math.sqrt((t[0].x-t[1].x)**2+(t[0].y-t[1].y)**2),s=Math.sqrt((t[1].x-t[2].x)**2+(t[1].y-t[2].y)**2),i=Math.sqrt((t[0].x-t[2].x)**2+(t[0].y-t[2].y)**2),r=Math.acos(k((e**2+i**2-s**2)/(2*e*i),-1,1)),n=Math.acos(k((e**2+s**2-i**2)/(2*e*s),-1,1)),c=Math.acos(k((i**2+s**2-e**2)/(2*i*s),-1,1)),a=k(e/(2*Math.sin(c)),0,Number.MAX_SAFE_INTEGER),u=t[2].x-t[0].x,f=t[2].y-t[0].y,m=f/u,h=t[0].y-m*t[0].x,g=(t[0].x*Math.sin(2*r)+t[1].x*Math.sin(2*n)+t[2].x*Math.sin(2*c))/(Math.sin(2*r)+Math.sin(2*n)+Math.sin(2*c)),b=(t[0].y*Math.sin(2*r)+t[1].y*Math.sin(2*n)+t[2].y*Math.sin(2*c))/(Math.sin(2*r)+Math.sin(2*n)+Math.sin(2*c));const p=Math.abs(m)===1/0||(t[1].y-(m*t[1].x+h))*(b-(m*g+h))<0?Math.asin(k(i/(2*a),0,1))*2:Math.PI*2-Math.asin(k(i/(2*a),0,1))*2;if(u===0){if(f===0){const G=this.generatePointsList([t[0],t[1]]),B=this.generatePointsList([t[1],t[2]]);return{points:G.points.concat(B.points),length:G.length+B.length}}const w=Math.round((t[1].x-t[0].x)*1e3)/1e3,M=Math.round((g-t[0].x)*1e3)/1e3;if(w<0&&M>=0&&(d=(f>0?-1:1)*p),w>0&&M<=0&&(d=(f>0?1:-1)*p),w>0&&M>=0&&(d=(f>0?-1:1)*Math.abs(Math.PI*2-p)),w<0&&M<=0&&(d=(f>0?1:-1)*Math.abs(Math.PI*2-p)),w==0&&M==0)return t.splice(1,1),this.generatePointsList(t)}else{const w={x:t[1].x,y:t[1].x*m+h};if(this.time===130364&&console.log(w),this.Dist(w,t[1])<.1)return t.splice(1,1),this.generatePointsList(t);d=u*(t[1].y-(m*t[1].x+h))<0?p:-p}const A=[];let O=0;for(let w=0;w<1;w+=Math.max(1/this.sliderLength,y.SLIDER_ACCURACY)){const M={x:g+(t[0].x-g)*Math.cos(d*w)-(t[0].y-b)*Math.sin(d*w),y:b+(t[0].x-g)*Math.sin(d*w)+(t[0].y-b)*Math.cos(d*w),t:w};w>0&&(O+=this.Dist(A.at(-1),M)),A.push(M)}return{points:A,length:O}}getAngleList(t){let e=[];e.push(0);for(let a=0;a<t.length-1;a++)this.Dist(t[a],t[a+1])===0&&e.push(a);e.push(t.length-1);const s=(this.sliderType==="P"?[this.getCirclePoints(t)]:e.map((a,d)=>d===e.length-1?void 0:this.generatePointsList(a===0?t.slice(e[d],e[d+1]+1):t.slice(e[d]+1,e[d+1]+1)))).filter(a=>a),i=s.map(a=>a.points).reduce((a,d)=>a.concat(d),[]).filter(a=>a),r=s.reduce((a,d)=>a+d.length,0),n=Math.floor(this.sliderLength/r*(i.length-1)),c=i.slice(0,n);return c.map((a,d,u)=>{var m;let f=((m=u[d-1])==null?void 0:m.angle)??0;if(d!==u.length-1){const h=u[d+1]??u[d],g={x:h.x-a.x,y:h.y-a.y},b={x:g.x/Math.hypot(g.x,g.y),y:g.y/Math.hypot(g.x,g.y)};f=Math.atan2(b.y,b.x)*180/Math.PI}return a.angle=f,a.t=d/(c.length-1),a})}getPointAtTime(t){if(t<=this.time)return this.realTrackPoints.at(0);if(t>=this.endTime)return this.realTrackPoints.at(-1);const e=Math.floor((t-this.time)/(this.endTime-this.time)*(this.realTrackPoints.length-1)),s=Math.ceil((t-this.time)/(this.endTime-this.time)*(this.realTrackPoints.length-1)),r=(t-this.time)/(this.endTime-this.time)*(this.realTrackPoints.length-1)%e,n=this.realTrackPoints[e].x+r*(this.realTrackPoints[s].x-this.realTrackPoints[e].x),c=this.realTrackPoints[e].y+r*(this.realTrackPoints[s].y-this.realTrackPoints[e].y),a=this.realTrackPoints[e].angle+r*(this.realTrackPoints[s].angle-this.realTrackPoints[e].angle),d=(t-this.time)/(this.endTime-this.time);return{x:n,y:c,t:d,angle:a}}getSliderPart(){const t=[],e=this.endTime;for(let r=0;r<this.sliderTicksCount/this.repeat;r++)t.push(this.angleList[Math.round((r+1)*this.beatStep/this.sliderTime/I.stats.sliderTickRate*(this.angleList.length-1))]);const s=[],i={...this.realTrackPoints[Math.round(k((this.killTime-this.time-36)/(e-this.time),0,1)*(this.realTrackPoints.length-1))],type:"Slider End",time:e-36<this.time?e-15:e-36};for(let r=0;r<this.repeat;r++){const n=this.sliderTime-this.sliderTicksCount/this.repeat*this.beatStep,c=r%2===0?this.angleList.at(-1):this.angleList[0];s.push(...t.map((a,d)=>({...a,type:"Slider Tick",time:r%2===0?r*this.sliderTime+Math.floor(this.time+(d+1)*this.beatStep/I.stats.sliderTickRate):(r-1)*this.sliderTime+Math.floor(this.time+this.sliderTime+d*this.beatStep/I.stats.sliderTickRate+n)}))),r<this.repeat-1&&s.push({...c,type:"Slider Repeat",time:this.time+Math.round((r+1)*this.sliderTime)})}this.sliderParts=s,this.sliderEndEvalPosition=i}eval(t){var b,p,A,O;const e=this.endTime,s=54.4-4.48*I.stats.circleSize;let i=ScoreParser.CURSOR_DATA[t],r=t,n=this.hitCircle.eval(t);for(;!n;)if(n=this.hitCircle.eval(++t),!ScoreParser.CURSOR_DATA[t])return null;if(n===null)return null;let c=n.val===0?"UNTRACKING":"TRACKING",a=0;const d=this.sliderParts.concat([this.sliderEndEvalPosition]).sort((w,M)=>w.time>M.time?1:w.time<M.time?-1:0),u=[{type:"Slider Head",eval:n.val===0?0:1}],f=I.moddedStats.stackOffset,m={x:this.stackHeight*f,y:this.stackHeight*f};let h=n.inputTime;for(;i.time<=e;){const w=this.getPointAtTime(i.time);if(!w){if(i=ScoreParser.CURSOR_DATA[++r],!i)break;continue}const M=mods.HR?Add(FlipHR(w),m):Add(w,m);if(c==="TRACKING"&&(i.inputArray.length===0||it(Dist(i,M)/(2.4*s),5)>1)&&(c="UNTRACKING"),c==="UNTRACKING"&&i.inputArray.length!==0&&it(Dist(i,M)/s,5)<1&&(c="TRACKING",h||(h=i.time)),d[a]&&((b=ScoreParser.CURSOR_DATA[r+1])==null?void 0:b.time)>((p=d[a])==null?void 0:p.time)){if(i.time!==((A=d[a])==null?void 0:A.time)){const G=ScoreParser.CURSOR_DATA[r+1],B=LinearEstimation(i,G,(d[a].time-i.time)/(G.time-i.time));c==="TRACKING"&&(i.inputArray.length===0||it(Dist(B,mods.HR?FlipHR(d[a]):d[a])/(2.4*s),5)>1)&&(c="UNTRACKING"),c==="UNTRACKING"&&i.inputArray.length!==0&&it(Dist(i,d[a])/s,5)<1&&(c="TRACKING",h||(h=i.time))}u.push({type:d[a].type,eval:c==="TRACKING"&&i.time<=d[a].time?1:0}),a++}if((!d[a]||d[a].time>=((O=ScoreParser.CURSOR_DATA[r+1])==null?void 0:O.time))&&r++,i=ScoreParser.CURSOR_DATA[r],!i)break}return{val:u.every(w=>w.eval===1)?300:u.every(w=>w.eval===0)?0:u.filter(w=>w.eval===1).length*2>=1+this.sliderTicksCount*this.repeat+this.repeat?100:50,valV2:n.val,checkPointState:u,delta:n.delta,inputTime:h}}get approachCircleObj(){return this.hitCircle.approachCircleObj}}let Ct=class{constructor(t,e,s){o(this,"time");o(this,"endTime");o(this,"obj");o(this,"approachCircle");o(this,"hitSounds");o(this,"comboIdx",1);o(this,"colourIdx",-1);o(this,"colourHaxedIdx",-1);this.time=t,this.hitTime=e,this.killTime=e+240,this.endTime=e;const i=new PIXI.Container,r=new PIXI.Container,n=new PIXI.Graphics().lineStyle({width:2,color:16777215,alpha:1,cap:"round",alignment:0}).drawCircle(0,0,192);r.addChild(n);const c=new PIXI.Graphics().lineStyle({width:2,color:16777215,alpha:1,cap:"round",alignment:0}).drawCircle(0,0,5);i.addChild(r),i.addChild(c),i.x=256*y.WIDTH/512,i.y=192*y.WIDTH/512,this.obj=i,this.approachCircle=r,this.hitSounds=s}playHitsound(t){if(beatmapFile.audioNode.isPlaying&&!(t<this.endTime||z.lastTimestamp>=this.endTime)&&!ScoreParser.REPLAY_DATA){this.hitSounds.play();return}}draw(t){if(this.obj.x=256*y.SCALE_RATE,this.obj.y=192*y.SCALE_RATE,this.playHitsound(t),t<this.time){let e=k(I.stats.approachRate*(mods.HR?1.4:1)*(mods.EZ?.5:1),0,10);const s=e<5?800+400*(5-e)/5:e>5?800-500*(e-5)/5:800;this.obj.alpha=1-Math.min(1,Math.max(0,(this.time-t)/s)),this.approachCircle.scale.set(1*y.SCALE_RATE);return}if(this.time<=t&&t<=this.hitTime){const e=1-Math.max(0,Math.min(1,(t-this.time)/(this.hitTime-this.time)));this.approachCircle.scale.set(e*y.SCALE_RATE),this.obj.alpha=1;return}if(t>this.hitTime){this.obj.alpha=1-Math.min(1,Math.max(0,(t-this.hitTime)/240)),this.approachCircle.scale.set(0*y.SCALE_RATE);return}}eval(t){const e=[],s=this.hitTime-this.time;let i=0,r=0,n=0,c=0,a=0,d=0,u,f=0,m=0,h=0;const g=I.stats.overallDifficulty,b=I.difficultyRange(g,3,5,7.5),p=Math.floor(s/1e3*b),A=ScoreParser.IS_OLD_VER?p:Math.max(0,p/4),O=ScoreParser.IS_OLD_VER?p+1:p,w=8e-5+Math.max(0,(5e3-s)/1e3/2e3);let M=0,G=t;for(;ScoreParser.CURSOR_DATA[G].time<this.hitTime;){if(ScoreParser.CURSOR_DATA[G].time<this.time){G++;continue}const Y=TranslateToZero(ScoreParser.CURSOR_DATA[G]),C=Math.atan2(Y.y,Y.x);let P=Y.time-ScoreParser.CURSOR_DATA[G-1].time;ScoreParser.CURSOR_DATA[G-1].time===0&&(P=100/6);const v=ApplyModsToTime(w*P,ScoreParser.MODS);if(i>r){const Q=v;r+=Math.min(i-r,Q)}else{const Q=-v;r+=Math.max(i-r,Q)}r=k(r,-.05,.05);const N=.9**(P/100*6);h=h*N+(1-N)*Math.abs(r)*1e3/(2*Math.PI)*60,u=u||(ScoreParser.IS_OLD_VER?0:C);let _=C-u;const F=-Math.PI;_<F?_=2*Math.PI+C-u:-_<F&&(_=-2*Math.PI-u+C);const K=.9**(P/100*6);M=K*M+(1-K)*P,_===0?(n++,n<2?i/=3:i=0):(n=0,(Y.inputArray.length===0||Y.time<this.time)&&(_=0),Math.abs(_)<Math.PI?ApplyModsToTime(M,ScoreParser.MODS)>100/6*1.04?P>0?i=_/ApplyModsToTime(M,ScoreParser.MODS):i=0:i=_/(100/6):i=0),u=C;const X=r*P,j=h*P/6e4*(Math.PI*2);if(c+=Math.min(1,Math.abs(X/Math.PI)),Math.floor(c)==d){e.push({time:Y.time,delta:Math.abs(_*180/Math.PI),rotationCount:c,result:0,rpm:h,rotated:X,rotatedByRPM:j,diff:Math.abs(X)-Math.abs(j)}),G++;continue}a++;let W=0,U=0;a>p+3&&(a-(p+3))%2===0?(W+=1100,U+=600):a>1&&a%2===0&&(W+=100,U+=100),e.push({time:Y.time,delta:Math.abs(_*180/Math.PI),rotationCount:c,result:W,rpm:h,rotated:X,rotatedByRPM:j,diff:Math.abs(X)-Math.abs(j)}),d=Math.floor(c),f+=W,m+=U,G++}let B=0;return ScoreParser.IS_OLD_VER?B=A===0?300:a<A?0:a>O?300:a>O-2?100:50:B=a<A?0:a>O?300:a>O-1?100:50,{val:B,valV2:B,bonus:f,bonusV2:m,inputTime:-1}}get approachCircleObj(){return null}};class Re extends Xt{constructor(t){super(t)}draw(t,e=""){this.obj.removeChildren().forEach(r=>r.destroy());let i=null;e.toString().split("").forEach((r,n)=>{const c=L.SKIN_ENUM[skinning.type],a=c!=="CUSTOM"?D.LEGACY:D.CUSTOM[L.SKIN_IDX],d=new PIXI.Sprite(a.DEFAULTS[r].texture);if(d.scale.set(a.DEFAULTS[r].isHD?.5*.8:.8),d.anchor.set(.5),i){const u=c==="LEGACY"||c==="ARGON"?L.HIT_CIRCLE_OVERLAP:L.SKIN_LIST[L.SKIN_IDX].ini.HIT_CIRCLE_OVERLAP;d.x=i.x+i.width/2+d.width/2-u*.8}i=d,this.obj.addChild(d)}),this.obj.alpha=1,this.obj.x=-i.x/2}}class pt{constructor(t){o(this,"obj");o(this,"hitCircle");o(this,"hitCircleOverlay");o(this,"selected");o(this,"NumberSprite");o(this,"hitObject");this.obj=new PIXI.Container,this.obj.interactive=!0,this.hitObject=t;const e=new PIXI.Sprite(D.LEGACY.HIT_CIRCLE.texture),s=new PIXI.Sprite(D.LEGACY.HIT_CIRCLE_OVERLAY.texture),i=new PIXI.Sprite(D.SELECTED.texture),r=new Re(t);e.anchor.set(.5,.5),s.anchor.set(.5,.5),i.anchor.set(.5,.5),this.hitCircle=e,this.hitCircle.tint=16777215,this.hitCircleOverlay=s,this.selected=i,this.numberSprite=r,this.obj.addChild(e),this.obj.addChild(s),this.obj.addChild(r.obj),this.obj.addChild(i),this.obj.scale.set(T.HEIGHT/1.5/this.hitCircle.height),this.obj.x=0,this.obj.y=T.HEIGHT/2;const n=c=>{const{x:a,y:d}=this.obj.toLocal(c.global);selectedHitObject.includes(this.hitObject.time)||Math.abs(a)>T.HEIGHT/2/2||(c.ctrlKey||(selectedHitObject=[]),selectedHitObject.includes(this.hitObject.time)||selectedHitObject.push(this.hitObject.time),T.hitArea.isObjectSelecting=!0)};this.obj.on("mousedown",n),this.obj.on("touchstart",n)}addSelfToContainer(t){t.addChild(this.obj)}removeSelfFromContainer(t){t.removeChild(this.obj)}draw(t,e){const s=this.hitObject.time,i=t-s,r=T.WIDTH/2;this.obj.x=r-i/500*T.ZOOM_DISTANCE;const n=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,c=sliderAppearance.ignoreSkin?this.hitObject.colourIdx:this.hitObject.colourHaxedIdx,d=L.SKIN_ENUM[skinning.type]!=="CUSTOM"?D.LEGACY:D.CUSTOM[L.SKIN_IDX];this.hitCircle.tint=n[c%n.length],this.hitCircle.texture=d.HIT_CIRCLE.texture,this.hitCircle.scale.set(d.HIT_CIRCLE.isHD?.5:1),this.hitCircleOverlay.texture=d.HIT_CIRCLE_OVERLAY.texture,this.hitCircleOverlay.scale.set(d.HIT_CIRCLE_OVERLAY.isHD?.5:1),this.obj.scale.set(T.HEIGHT/(T.SHOW_GREENLINE?1.5:1)/this.hitCircle.height),this.obj.y=T.HEIGHT/2,this.selected.visible=!1,selectedHitObject.includes(s)&&(this.selected.visible=!0),!e&&this.numberSprite.draw(t,this.hitObject.comboIdx)}}class Ee extends pt{constructor(e,s){super(e);o(this,"hitObject");o(this,"slider");this.hitObject=e,this.slider=s,this.obj.removeChild(this.numberSprite.obj),this.numberSprite=new PIXI.Sprite(D.LEGACY.REVERSE_ARROW.arrow.texture),this.numberSprite.anchor.set(.5),this.numberSprite.scale.set(1),this.obj.addChildAt(this.numberSprite,2)}draw(e){super.draw(e,!0);const s=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,i=sliderAppearance.ignoreSkin?this.slider.colourIdx:this.slider.colourHaxedIdx;this.hitCircle.tint=s[i%s.length];const n=L.SKIN_ENUM[skinning.type]!=="CUSTOM"?D.LEGACY:D.CUSTOM[L.SKIN_IDX];this.numberSprite.texture=n.REVERSE_ARROW.arrow.texture,this.numberSprite.scale.set(n.REVERSE_ARROW.arrow.isHD?.5:1)}}const Le=`
precision mediump float;
attribute vec2 position;
attribute float dist;

varying float colorDist;

// uniform float dx, dy, ox, oy;
uniform mat3 translationMatrix;
uniform mat3 projectionMatrix;

void main() {
    colorDist = dist;
    // gl_Position = vec4(position.xy, 0.0, 1.0);
    // gl_Position.x = position.x * dx + ox;
    // gl_Position.y = position.y * dy + oy;

    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);
}
`,xe=`
precision mediump float;

uniform vec4 tint;
uniform bool selected;
varying float colorDist;

vec4 lighten(vec4 color, float amount) {
    amount *= 0.5;
    color.r = min(1.0, color.r * (1.0 + 0.5 * amount) + 1.0 * amount);
    color.g = min(1.0, color.g * (1.0 + 0.5 * amount) + 1.0 * amount);
    color.b = min(1.0, color.b * (1.0 + 0.5 * amount) + 1.0 * amount);

    return color;
}

vec4 darken(vec4 color, float amount) {
    float scalar = max(1.0, 1.0 + amount);
    color.r = min(1.0, color.r / scalar);
    color.g = min(1.0, color.g / scalar);
    color.b = min(1.0, color.b / scalar);
    return color;
}

void main() {
    float blurRate = 0.1;
    float alpha = 1.0;
    float totalAlpha = 0.7;

    vec4 outerColor = darken(tint, 0.1);
    vec4 innerColor = tint;

    vec4 color = mix(outerColor, innerColor, colorDist);
    if (selected) {
        color = tint;
        totalAlpha = 1.0;
    }

    color.a = 1.0;

    if (colorDist > 1.0 - blurRate)
        alpha = (1.0 - colorDist) / blurRate;

    gl_FragColor = totalAlpha * alpha * color;
}
`;class Dt{constructor(t){o(this,"obj");o(this,"hitObject");o(this,"sliderHead");o(this,"sliderTail");o(this,"sliderReverses",[]);o(this,"meshHead");o(this,"meshTail");o(this,"meshBody");o(this,"ratio",1);o(this,"headPosition",0);var h;this.obj=new PIXI.Container,this.obj.interactive=!0,this.x=0,this.radius=30*(118/128),this.hitObject=t,this.length=1,this.hitArea=new PIXI.Graphics().drawRect(0,0,0,0),this.obj.addChild(this.hitArea);const e=this.createArc(-1,0),s=this.createArc(1,0),i=this.createLine(1),r={tint:[0,0,0,1]},n=PIXI.Shader.from(Le,xe,r),c=new PIXI.Mesh(e,n),a=new PIXI.Mesh(i,n),d=new PIXI.Mesh(s,n);this.meshHead=c,this.meshBody=a,this.meshTail=d,this.meshHead.hitArea=new PIXI.Rectangle(0,0,0,0),this.meshBody.hitArea=new PIXI.Rectangle(0,0,0,0),this.meshTail.hitArea=new PIXI.Rectangle(0,0,0,0),this.obj.addChild(c),this.obj.addChild(d),this.obj.addChild(a);const u=new pt(t),f=new pt(t);this.sliderHead=u,this.sliderTail=f,this.sliderReverses=((h=this.hitObject.revArrows)==null?void 0:h.map(g=>new Ee(g,this.hitObject)))??[],this.obj.addChild(f.obj),this.sliderReverses.toReversed().forEach(g=>this.obj.addChild(g.obj)),this.obj.addChild(u.obj);const m=g=>{const{x:b,y:p}=this.obj.toLocal(g.global);selectedHitObject.includes(this.hitObject.time)||b<this.headPosition-(T.HEIGHT-20)/2||b>this.headPosition+this.length*this.ratio+T.HEIGHT/1.5/2||(g.ctrlKey||(selectedHitObject=[]),selectedHitObject.includes(this.hitObject.time)||selectedHitObject.push(this.hitObject.time),T.hitArea.isObjectSelecting=!0)};this.obj.on("mousedown",m),this.obj.on("touchstart",m)}addSelfToContainer(t){t.addChild(this.obj)}removeSelfFromContainer(t){t.removeChild(this.obj)}draw(t){const e=this.hitObject.time,s=t-e,i=selectedHitObject.includes(e),r=T.WIDTH/2;this.length=(this.hitObject.endTime-this.hitObject.time)/500*T.ZOOM_DISTANCE;const n=sliderAppearance.ignoreSkin?L.DEFAULT_COLORS:I.COLORS,c=sliderAppearance.ignoreSkin?this.hitObject.colourIdx:this.hitObject.colourHaxedIdx,a=c===-1?[1,1,1]:Object.values(d3.rgb(`#${n[c%n.length].toString(16).padStart(6,"0")}`)).map(m=>m/255);let d=Math.max(r-s/500*T.ZOOM_DISTANCE,0);this.headPosition=d;let u=r-s/500*T.ZOOM_DISTANCE+this.length;u<0&&(d=u);const f=k((u-d)/this.length,0,1);this.ratio=f,this.meshHead.position.set(d,T.HEIGHT/2),this.meshHead.scale.set(T.HEIGHT/(T.SHOW_GREENLINE?1.5:1)/60),this.meshHead.shader.uniforms.tint=a,this.meshHead.shader.uniforms.selected=i,this.meshBody.position.set(d,T.HEIGHT/2),this.meshBody.scale.set(this.length*f,T.HEIGHT/(T.SHOW_GREENLINE?1.5:1)/60),this.meshBody.shader.uniforms.tint=a,this.meshHead.shader.uniforms.selected=i,this.meshTail.position.set(u,T.HEIGHT/2),this.meshTail.scale.set(T.HEIGHT/(T.SHOW_GREENLINE?1.5:1)/60),this.meshTail.shader.uniforms.tint=a,this.meshHead.shader.uniforms.selected=i,this.sliderHead.draw(t),this.sliderTail.draw(t,!0),this.sliderHead.obj.x=d,this.sliderTail.obj.x=u,this.hitArea.clear(),this.hitArea.beginFill(16776960,1e-4).drawRect(d,0,this.length*f,T.HEIGHT),this.sliderReverses.forEach(m=>m.draw(t)),c===-1&&(this.sliderHead.hitCircle.tint=14606046,this.sliderTail.hitCircle.tint=14606046)}createArc(t,e){t/=Math.abs(t);const s=[],i=[],r=[0,0],n=400;for(let a=0;a<n;a++){const d=a/n*Math.PI*t,u=(a+1)/n*Math.PI*t;s.push(...r,this.radius*Math.sin(d),this.radius*Math.cos(d),this.radius*Math.sin(u),this.radius*Math.cos(u)),i.push(0,1,1)}return new PIXI.Geometry().addAttribute("position",s,2).addAttribute("dist",i,1)}createLine(t){const e=[this.x,this.radius,this.x+t,this.radius,this.x,0,this.x,0,this.x+t,this.radius,this.x+t,0,this.x,0,this.x+t,0,this.x,-this.radius,this.x,-this.radius,this.x+t,0,this.x+t,-this.radius],s=[1,1,0,0,1,0,0,0,1,1,0,1];return new PIXI.Geometry().addAttribute("position",e,2).addAttribute("dist",s,1)}}const R=class R{constructor(t,e){o(this,"objectsController");R.COLORS=L.DEFAULT_COLORS,R.loadMetadata(t.split(`\r
`)),t.split(`\r
`).filter(C=>C.includes("ApproachRate:")).length===0?R.stats.approachRate=parseFloat(t.split(`\r
`).filter(C=>C.includes("OverallDifficulty:")).at(0).replaceAll("OverallDifficulty:","")):R.stats.approachRate=parseFloat(t.split(`\r
`).filter(C=>C.includes("ApproachRate:")).at(0).replaceAll("ApproachRate:","")),R.stats.circleSize=parseFloat(t.split(`\r
`).filter(C=>C.includes("CircleSize:")).at(0).replaceAll("CircleSize:","")),R.stats.HPDrainRate=parseFloat(t.split(`\r
`).filter(C=>C.includes("HPDrainRate:")).at(0).replaceAll("HPDrainRate:","")),R.stats.stackLeniency=t.includes("StackLeniency: ")?parseFloat(t.split(`\r
`).filter(C=>C.includes("StackLeniency: ")).at(0).replaceAll("StackLeniency: ","")):.7,R.SAMPLE_SET=t.includes("SampleSet: ")?t.split(`\r
`).filter(C=>C.includes("SampleSet: ")).at(0).replaceAll("SampleSet: ",""):"Normal",R.stats.sliderTickRate=parseFloat(t.split(`\r
`).filter(C=>C.includes("SliderTickRate:")).at(0).replaceAll("SliderTickRate:","")),R.stats.overallDifficulty=parseFloat(t.split(`\r
`).filter(C=>C.includes("OverallDifficulty:")).at(0).replaceAll("OverallDifficulty:",""));const s=mods.HR?1.3:1,i=mods.EZ?.5:1;R.hitWindows={GREAT:Math.floor(80-6*k(R.stats.overallDifficulty*s*i,0,10)),OK:Math.floor(140-8*k(R.stats.overallDifficulty*s*i,0,10)),MEH:Math.floor(200-10*k(R.stats.overallDifficulty*s*i,0,10))},R.stats.circleDiameter=2*(54.4-4.48*R.stats.circleSize)*236/256,stackThreshold=R.stats.preempt*R.stats.stackLeniency;const r=t.indexOf("[Difficulty]")+14,n=t.indexOf("[TimingPoints]")+16,c=t.indexOf("[Colours]")+11,a=t.indexOf("[HitObjects]")+14,d=parseFloat(t.slice(r).split(`\r
`)[t.split(`\r
`).filter(C=>C.includes("ApproachRate:")).length===0?3:4].replace("SliderMultiplier:",""))*100,u=t.slice(n,t.indexOf("[Colours]")!==-1?c-11:a-14).split(`\r
`).filter(C=>{const P=C.split(",");return C!==""&&P[1]>0}).map(C=>{const P=C.split(",");return{time:parseInt(P[0]),beatstep:parseFloat(P[1])}});R.beatStepsList=u;const f=t.slice(n,t.indexOf("[Colours]")!==-1?c-11:a-14).split(`\r
`).filter(C=>C!=="").map(C=>{const P=C.split(",");return{time:parseInt(P[0]),svMultiplier:P[1]>0?1:parseFloat((-1/P[1]*100).toFixed(2)),sampleSet:parseInt(P[3]??"0"),sampleIdx:parseInt(P[4]??"0"),sampleVol:parseInt(P[5]??"100"),isKiai:parseInt(P[7]??0)!==0}});R.timingPointsList=f,f.forEach((C,P)=>{const v=new jt(C);T.beatLines.greenLines.push(v)}),R.mergedPoints=[...R.beatStepsList,...R.timingPointsList].sort((C,P)=>C.time<P.time?-1:C.time>P.time||C.beatstep?1:P.beatstep?-1:0),V.initTimingPoints();let m=t.indexOf("[Colours]")!==-1?t.slice(c,a-14).split(`\r
`).filter(C=>C!==""&&C.match(/Combo[0-9]+\s:\s/g)).map(C=>`rgb(${C.replaceAll(C.match(/Combo[0-9]+\s:\s/g)[0],"")})`).map(C=>parseInt(C.replaceAll("rgb(","").replaceAll(")","").split(",").map(P=>parseInt(P).toString(16).padStart(2,"0")).join(""),16)):[];m.length===0&&(m=L.DEFAULT_COLORS),R.COLORS=L.DEFAULT_COLORS,R.COLORS=m,SliderTexture=Pt(),SelectedTexture=Pt();const h=t.split(`\r
`).filter(C=>/^2,[0-9]+,[0-9]+$/g.test(C)).map(C=>C.split(",").slice(1).map(P=>parseInt(P)));let g=t.slice(a).split(`\r
`).filter(C=>C!==""),b=1,p=1,A=1,O=performance.now();const w=g.map((C,P)=>{const v=C.split(","),N=parseInt(v[2]);let _=R.findNearestTimingPoint(N,"timingPointsList"),F,K=null;const X=parseInt(v[3]).toString(2).padStart(8,"0").split("").reverse().map(W=>W==="1"),j=parseInt(parseInt(v[3]).toString(2).padStart(8,"0").split("").reverse().slice(4,7).reverse().join(""),2);return X[0]&&(F=R.constructHitCircle(v,_),K=new pt(F.obj)),X[1]&&(F=R.constructSlider(v,f,u,d),K=new Dt(F.obj)),X[3]&&(F=R.constructSpinner(v,_),K=new Dt(F.obj)),X[2]&&P!==0&&(b=1,p++,A++),j!==0&&X[2]&&(A+=j),F.obj.comboIdx=b,F.obj.colourIdx=p,F.obj.colourHaxedIdx=A,F.obj instanceof Z&&(F.obj.hitCircle.comboIdx=b,F.obj.hitCircle.colourIdx=p,F.obj.hitCircle.colourHaxedIdx=A),F.obj instanceof Ct&&(F.obj.comboIdx=1,F.obj.colourIdx=-1,F.obj.colourHaxedIdx=-1),b++,{...F,timelineObject:K}}).filter(C=>C);console.log(`Took: ${performance.now()-O}ms to finish objects construction.`),O=performance.now(),this.objectsController=new z(w,m,h),console.log(`Took: ${performance.now()-O}ms to finish objectsController construction.`);let M=this.objectsController.objectsList.length-1,G=0;const B=3;for(let C=M;C>0;C--){let P=C,v=this.objectsController.objectsList[C];if(v.obj.stackHeight==0){if(v.obj instanceof at)for(;--P>=0;){const N=this.objectsController.objectsList[P],_=N.obj.endTime;if(v.obj.time-_>stackThreshold)break;if(P<G&&(N.obj.stackHeight=0,G=P),N.obj instanceof Z&&this.calculateDistance([N.obj.angleList.at(-1).x,N.obj.angleList.at(-1).y],[parseInt(v.obj.originalX),parseInt(v.obj.originalY)])<B){let F=v.obj.stackHeight-N.obj.stackHeight+1;for(let K=P+1;K<=C;K++){const X=this.objectsController.objectsList[K];this.calculateDistance([N.obj.angleList.at(-1).x,N.obj.angleList.at(-1).y],X.obj instanceof Z?[X.obj.angleList.at(0).x,X.obj.angleList.at(0).y]:[parseInt(X.obj.originalX),parseInt(X.obj.originalY)])&&(X.obj.stackHeight-=F)}break}this.calculateDistance(N.obj instanceof Z?[N.obj.angleList.at(0).x,N.obj.angleList.at(0).y]:[parseInt(N.obj.originalX),parseInt(N.obj.originalY)],[parseInt(v.obj.originalX),parseInt(v.obj.originalY)])<B&&(N.obj.stackHeight=v.obj.stackHeight+1,v=N)}else if(v.obj instanceof Z)for(;--P>=0;){const N=this.objectsController.objectsList[P];if(v.obj.time-N.obj.time>stackThreshold)break;this.calculateDistance(N.obj instanceof Z?[N.obj.angleList.at(-1).x,N.obj.angleList.at(-1).y]:[parseInt(N.obj.originalX),parseInt(N.obj.originalY)],v.obj instanceof Z?[v.obj.angleList.at(0).x,v.obj.angleList.at(0).y]:[parseInt(v.obj.originalX),parseInt(v.obj.originalY)])<B&&(N.obj.stackHeight=v.obj.stackHeight+1,v=N)}R.updateStats(),R.updateModdedStats()}}this.objectsController.slidersList.forEach(C=>{C.obj.hitCircle.stackHeight=C.obj.stackHeight});const Y=(this.objectsController.objectsList.at(-1).obj.time-(h.reduce((C,P)=>C+(P[1]-P[0]),0)+this.objectsController.objectsList.at(0).obj.time))/1e3;R.difficultyMultiplier=Math.round((R.stats.HPDrainRate+R.stats.circleSize+R.stats.overallDifficulty+k(this.objectsController.objectsList.length/Y*8,0,16))/38*5)}static difficultyRange(t,e,s,i){return t>5?s+(i-s)*(t-5)/5:t<5?s-(s-e)*(5-t)/5:s}static updateModdedStats(){const t=mods.HR?1.4:1,e=mods.EZ?.5:1,s=mods.HR?1.3:1,i=Math.min(R.stats.circleSize*s*e,10),r=Math.min(R.stats.approachRate*t*e,10),n=Math.min(R.stats.HPDrainRate*t*e,10),c=Math.min(R.stats.overallDifficulty*t*e,10);R.moddedStats={...R.stats,circleSize:i,approachRate:r,HPDrainRate:n,overallDifficulty:c,preempt:R.difficultyRange(r,1800,1200,450),fadeIn:R.difficultyRange(r,1200,800,300),radius:54.4-4.48*i,stackOffset:-6.4*(1-.7*(i-5)/5)/2}}static updateStats(){const{circleSize:t,approachRate:e}=R.stats;R.stats={...R.stats,preempt:R.difficultyRange(e,1800,1200,450),fadeIn:R.difficultyRange(e,1200,800,300),radius:54.4-4.48*t,stackOffset:-6.4*(1-.7*(t-5)/5)/2}}static constructSpinner(t,e){const s=t.map(u=>u===""||!u?null:u),i=parseInt(s[2]),r=parseInt(s[5]),n=s[4],c=s.at(-1),a=HitSound.GetName(c,n,e),d=new q(a,e.sampleVol/100);return{obj:new Ct(i,r,d),hitsounds:d}}static constructSlider(t,e,s,i){const r=parseInt(t[4]),n=parseInt(t[2]),c=R.findNearestTimingPoint(n,"timingPointsList"),{beatstep:a}=R.findNearestTimingPoint(n,"beatStepsList"),d=parseInt(t[6]),u=parseFloat(t[7]),f=n+d*u/c.svMultiplier/i*a,m=R.findNearestTimingPoint(f,"timingPointsList"),h=t[8],g=t[9],b=/^\d:\d.*/g.test(t.at(-1))?t.at(-1):"0:0",p=HitSound.GetName((g==null?void 0:g.split("|")[0])??b,(h==null?void 0:h.split("|")[0])??r,c),A=HitSound.GetName((g==null?void 0:g.split("|").at(-1))??b,(h==null?void 0:h.split("|").at(-1))??r,m),O=[...Array(d-1)].map((K,X)=>{const j=n+(X+1)*u/c.svMultiplier/i*a,W=R.findNearestTimingPoint(j,"timingPointsList"),U=HitSound.GetName((g==null?void 0:g.split("|")[X+1])??b,(h==null?void 0:h.split("|")[X+1])??r,W);return new q(U,W.sampleVol/100)}),[w,M,,G]=t,B=t[5].slice(2),Y=t[5][0],C={normal:parseInt(b.split(":")[0]),additional:parseInt(b.split(":")[1]),hitSoundIdx:r},{normalSet:P}=HitSound.GetHitSample(b,c),v=new q([`${P}-sliderslide${c.sampleIdx}`],c.sampleVol/100),N=new q([`${P}-sliderwhistle${c.sampleIdx}`],c.sampleVol/100),_={sliderHead:new q(p,c.sampleVol/100),sliderTail:new q(A,m.sampleVol/100),sliderReverse:O,sliderSlide:v,sliderWhistle:N,defaultSet:C};return{obj:new Z(`${w}:${M}|${B}`,Y,u,c.svMultiplier,i,a,n,d,_),hitsounds:_}}static constructHitCircle(t,e){const s=t.map(h=>h===""||!h?null:h),[i,r,n,c,a,...d]=s,u=d.at(-1),f=HitSound.GetName(u,a,e);parseInt(n)===208128&&console.log(e,f);const m=new q(f,e.sampleVol/100);return{obj:new at(i,r,parseInt(n),m),hitsounds:m}}static findNearestTimingPoint(t,e,s){return R[e][R.findNearestTimingPointIndex(t,e,s)]}static findNearestTimingPointIndex(t,e,s){const i=s?0:2;let r=St(R[e],t,(n,c)=>n.time<c+i?-1:n.time>c+i?1:0);for(;r>0&&R[e][r].time>t+i;)r--;return R[e][r].time>t+i?0:r}static async loadProgressBar(){const t=document.createElement("div");t.classList.add("timingWrapper"),R.timingPointsList.forEach(e=>{const s=document.createElement("div");s.classList.add("greenLine"),s.style.left=`${e.time/beatmapFile.audioNode.duration*100}%`,t.appendChild(s)}),R.beatStepsList.forEach(e=>{const s=document.createElement("div");s.classList.add("redLine"),s.style.left=`${e.time/beatmapFile.audioNode.duration*100}%`,t.appendChild(s)}),document.querySelector(".timingPointsContainer").prepend(t),domtoimage.toPng(t).then(e=>{document.querySelector(".timingPointsContainer").removeChild(t),document.querySelector(".timingPointsContainer img").src=e})}static async loadTimingPoints(){[...document.querySelectorAll(".timingPoint")].forEach(t=>document.querySelector(".timingPanel").removeChild(t)),R.mergedPoints.forEach(t=>{const e=document.createElement("div");e.classList.add("timingPoint");const s=document.createElement("div");s.classList.add("timestamp");const i=document.createElement("div");i.classList.add("timingContent");const r=document.createElement("div");r.classList.add("timingFlair");const n=document.createElement("div");n.classList.add("timingValue"),i.append(r,n),e.append(s,i);let c=t.time;const a=c<0;c<0&&(c*=-1);const d=Math.floor(c/6e4),u=Math.floor((c-d*6e4)/1e3),f=c-d*6e4-u*1e3;if(s.textContent=`${a?"-":""}${d.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}:${f.toFixed(0).padStart(3,"0")}`,t.beatstep){n.textContent=`${(6e4/t.beatstep).toFixed(2)} BPM`,e.classList.add("beatStepPoint"),document.querySelector(".timingPanel").append(e);return}const m=document.createElement("div");m.classList.add("timingValue"),t.isKiai&&i.classList.add("kiai"),t.sampleIdx!==0?m.textContent=`${HitSound.HIT_SAMPLES[t.sampleSet][0].toUpperCase()}:C${t.sampleIdx}`:m.textContent=`${HitSound.HIT_SAMPLES[t.sampleSet][0].toUpperCase()}`;const h=document.createElement("div");h.classList.add("timingValue"),h.textContent=`${t.sampleVol}%`,i.append(m,h),n.textContent=`${t.svMultiplier.toFixed(2)}x`,e.classList.add("svPoint"),document.querySelector(".timingPanel").append(e)}),document.querySelector(".timings").textContent=`timings (${R.mergedPoints.length})`}static loadMetadata(t){const e=u=>{var f;return((f=t.filter(m=>m.includes(`${u}:`)).at(0))==null?void 0:f.replaceAll(`${u}:`,""))??""},s=e("Artist"),i=e("ArtistUnicode"),r=e("Title"),n=e("TitleUnicode"),c=e("Version"),a=e("Source"),d=e("Tags");document.querySelector(".meta-artist").textContent=i,document.querySelector(".meta-r-artist").textContent=s,document.querySelector(".meta-title").textContent=n,document.querySelector(".meta-r-title").textContent=r,document.querySelector(".meta-diff").textContent=c,document.querySelector(".meta-source").textContent=a,document.querySelector(".meta-tags").textContent=d}calculateDistance(t,e){const s=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(s**2+i**2)}render(){this.objectsController.render()}};o(R,"SAMPLE_SET","Normal"),o(R,"COLORS"),o(R,"difficultyMultiplier",1),o(R,"stats",{approachRate:5,circleSize:5,HPDrainRate:5,overallDifficulty:5,stackLeniency:7,circleDiameter:2*(54.4-4.48*5)*236/256,preempt:1200,fadeIn:800,sliderTickRate:1,radius:54.4-4.48*5,stackOffset:-6.4*(1-.7*0/5)/2}),o(R,"moddedStats",{approachRate:5,circleSize:5,HPDrainRate:5,overallDifficulty:5,stackLeniency:7,circleDiameter:2*(54.4-4.48*5)*236/256,preempt:1200,fadeIn:800,sliderTickRate:1,radius:54.4-4.48*5,stackOffset:-6.4*(1-.7*0/5)/2}),o(R,"hitWindows",{GREAT:80,OK:140,MEH:200}),o(R,"beatStepsList",[]),o(R,"timingPointsList",[]),o(R,"mergedPoints",[]);let I=R;function Ht(l){beatmapFile!=null&&beatmapFile.audioNode&&beatmapFile.audioNode.seekTo(l*beatmapFile.audioNode.buf.duration*1e3)}function Wt(l){var t,e;if(l==null||l.blur(),!(!((t=beatmapFile==null?void 0:beatmapFile.audioNode)!=null&&t.gainNode)||!((e=beatmapFile==null?void 0:beatmapFile.audioNode)!=null&&e.buf))){if(!beatmapFile.audioNode.isPlaying){document.querySelector("#playButton").style.backgroundImage="",beatmapFile.audioNode.play();return}document.querySelector("#playButton").style.backgroundImage="url(./static/pause.png)",beatmapFile.audioNode.pause()}}function Mt(l){const t=Math.floor(l%1e3),e=Math.floor(l/1e3%60),s=Math.floor(l/1e3/60),i=t.toString().padStart(3,"0").split(""),r=e.toString().padStart(2,"0").split("");return{minutes:s.toString().padStart(2,"0").split(""),seconds:r,miliseconds:i}}function ot(l,t){if(!beatmapFile||!beatmapFile.audioNode.isLoaded)return;let e=1,s=t?1:-1,i;const r=beatmapFile.audioNode.getCurrentTime(),n=beatmapFile.audioNode.isPlaying;I.beatStepsList.length&&(i=I.beatStepsList.findLast(u=>u.time<=r)??I.beatStepsList[0],e=l?1:i.beatstep/parseInt(beatsnap)*(!t&&n?2:1));const c=r-i.time,a=Math.round(c/e),d=k(Math.floor(i.time+(a+s)*e),0,beatmapFile.audioNode.buf.duration*1e3);beatmapFile.audioNode.seekTo(d)}document.querySelector("#prevButton").onclick=()=>ot(null,!1);document.querySelector("#playButton").onclick=()=>Wt(document.querySelector("#playButton"));document.querySelector("#nextButton").onclick=()=>ot(null,!0);function Ae(){const l=window.location.origin,t=beatmapFile!==void 0?parseInt(beatmapFile.audioNode.getCurrentTime()):0,e=currentMapId||"";navigator.clipboard.writeText(`${l}${l.includes("github.io")?"/beatmap-viewer-how":""}?b=${e}&t=${t}`),new Notification("Current preview timestamp copied").notify()}document.querySelector("#previewURL").onclick=Ae;function At(){const l=document.querySelector(".seekTo");l.classList.remove("popupAnim"),l.classList.add("popoutAnim"),l.close()}function we(){const l=document.querySelector(".seekTo");l.classList.remove("popoutAnim"),l.classList.add("popupAnim"),l.show()}function Pe(){const l=document.querySelector(".seekTo"),t=document.querySelector("#jumpToTime");if(t.blur(),!l.open){if(beatmapFile!=null&&beatmapFile.audioNode){const e=beatmapFile.audioNode.getCurrentTime(),s=Math.floor(e/6e4),i=Math.floor((e-s*6e4)/1e3),r=e-s*6e4-i*1e3;t.value=`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${r.toFixed(0).padStart(3,"0")}`;const n=window.location.origin,c=beatmapFile!==void 0?beatmapFile.audioNode.getCurrentTime():0,a=currentMapId||"";document.querySelector("#previewURL").value=`${n}${n.includes("github.io")?"/beatmap-viewer-how":""}?b=${a}&t=${c}`}we();return}At()}document.querySelector("#timeContainer").onclick=Pe;function Oe(l){if(!(beatmapFile!=null&&beatmapFile.audioNode)||!/^[0-9]+:[0-9]+:[0-9]+.*/g.test(l)&&!/^[0-9]+$/g.test(l)){document.querySelector("#jumpToTime").value="";return}let t=l;if(/^[0-9]+:[0-9]+:[0-9]+.*/g.test(l)){const e=l.match(/[0-9]+:[0-9]+:[0-9]+/g)[0],s=parseInt(e.split(":")[0]),i=parseInt(e.split(":")[1]),r=parseInt(e.split(":")[2]);t=s*6e4+i*1e3+r}beatmapFile.audioNode.seekTo(t)}document.querySelector("#jumpToTime").addEventListener("keydown",l=>{l.key==="Enter"&&(Oe(document.querySelector("#jumpToTime").value),At())});class rt{static createDigit(t=0,e="digit"){const s=new PIXI.BitmapText(e==="digit"?"0":":",{fontName:"Torus",fontSize:16,align:"center"});return s.anchor.set(.5),s.x=t,s.y=e==="digit"?this.HEIGHT/2:this.HEIGHT/2-1,s}static init(){this.renderer=new PIXI.Renderer({width:110,height:60,backgroundColor:5002858,antialias:!0,autoDensity:!0}),document.querySelector("#timeContainer").append(this.renderer.view),this.stage=new PIXI.Container,this.WIDTH=120,this.HEIGHT=60;const t=new PIXI.Container,e=new PIXI.Container,s=new PIXI.Container,i=new PIXI.Container;for(let r=0;r<2;r++){const n=this.createDigit(r*9);e.addChild(n),this.digits.minutes.push(n)}e.addChild(this.createDigit(16,"colon"));for(let r=0;r<2;r++){const n=this.createDigit(r*9);s.addChild(n),this.digits.seconds.push(n)}s.addChild(this.createDigit(16,"colon"));for(let r=0;r<3;r++){const n=this.createDigit(r*9);i.addChild(n),this.digits.miliseconds.push(n)}e.x=0,s.x=24,i.x=48,t.addChild(e,s,i),t.x=23,this.stage.addChild(t)}static update(t){const e=Mt(t),s=Mt(z.time);e.miliseconds.forEach((i,r)=>{i!==s.miliseconds[r]&&(this.digits.miliseconds[r].text=i)}),e.seconds.forEach((i,r)=>{i!==s.seconds[r]&&(this.digits.seconds[r].text=i)}),e.minutes.forEach((i,r)=>{i!==s.minutes[r]&&(this.digits.minutes[r].text=i)}),this.renderer.render(this.stage)}}o(rt,"renderer"),o(rt,"stage"),o(rt,"WIDTH"),o(rt,"HEIGHT"),o(rt,"digits",{minutes:[],seconds:[],miliseconds:[]});const Ut=(l,t)=>{const e=currentX,s=currentY;beatmapFile.audioNode.getCurrentTime();const i=startX,r=startY;let n=k(I.stats.approachRate*(mods.HR?1.4:1)*(mods.EZ?.5:1),0,10);const c=I.difficultyRange(n,1800,1200,450),a=beatmapFile.beatmapRenderData.objectsController.objectsList.filter(d=>{const u=d.obj.time-c,f=sliderAppearance.hitAnim?d.obj.killTime:Math.max(d.obj.time+800,d.obj.killTime);return u<=Math.min(draggingStartTime,draggingEndTime)&&f>=Math.max(draggingStartTime,draggingEndTime)||u>=Math.min(draggingStartTime,draggingEndTime)&&f<=Math.max(draggingStartTime,draggingEndTime)||u>=Math.min(draggingStartTime,draggingEndTime)&&u<=Math.max(draggingStartTime,draggingEndTime)||f>=Math.min(draggingStartTime,draggingEndTime)&&f<=Math.max(draggingStartTime,draggingEndTime)}).filter(d=>{const u={x:Math.min(e,i),y:Math.min(s,r)},f={x:Math.max(e,i),y:Math.max(s,r)};if(d.obj instanceof at){const m=d.obj.originalX+I.moddedStats.stackOffset*d.obj.stackHeight,h=(mods.HR?384-d.obj.originalY:d.obj.originalY)+I.moddedStats.stackOffset*d.obj.stackHeight;return m>=u.x&&m<=f.x&&h>=u.y&&h<=f.y}return d.obj instanceof Z?d.obj.angleList.some(g=>{const b=g.x+I.moddedStats.stackOffset*d.obj.stackHeight,p=(mods.HR?384-g.y:g.y)+I.moddedStats.stackOffset*d.obj.stackHeight;return b+I.moddedStats.stackOffset*d.obj.stackHeight>=u.x&&b+I.moddedStats.stackOffset*d.obj.stackHeight<=f.x&&p+I.moddedStats.stackOffset*d.obj.stackHeight>=u.y&&p+I.moddedStats.stackOffset*d.obj.stackHeight<=f.y}):!1});a.length?selectedHitObject=a.map(d=>d.obj.time):l&&!l.ctrlKey&&(selectedHitObject=[])},vt=(l,t,e)=>{const i=I.moddedStats.radius*.921875;if(e.obj instanceof at){const r=e.obj.originalX+I.moddedStats.stackOffset*e.obj.stackHeight,n=(mods.HR?384-e.obj.originalY:e.obj.originalY)+I.moddedStats.stackOffset*e.obj.stackHeight;return(l-r)**2+(t-n)**2<=i**2}return e.obj instanceof Z?e.obj.angleList.some(c=>{const a=c.x+I.moddedStats.stackOffset*e.obj.stackHeight,d=(mods.HR?384-c.y:c.y)+I.moddedStats.stackOffset*e.obj.stackHeight;return(l-a)**2+(t-d)**2<=i**2}):!1},tt=class tt{constructor(t,e,s){o(this,"hitCirclesList");o(this,"slidersList");o(this,"objectsList");o(this,"judgementList",[]);o(this,"drawTime");o(this,"coloursList");o(this,"breakPeriods");o(this,"currentColor");o(this,"coloursObject");o(this,"lastTimestamp",0);o(this,"lastTime",0);o(this,"tempW",y.WIDTH);o(this,"tempH",y.HEIGHT);o(this,"filtered",[]);o(this,"_in",[]);this.objectsList=t.sort(this.compare),this.hitCirclesList=t.filter(i=>i.obj instanceof at||i.obj instanceof Ct),this.slidersList=t.filter(i=>i.obj instanceof Z),this.breakPeriods=s}compare(t,e){return t.obj.time<e.obj.time?-1:t.obj.time>e.obj.time?1:0}draw(t,e){t>beatmapFile.audioNode.duration&&beatmapFile.audioNode.pause(),this.lastTime=performance.now(),didMove&&currentX!==-1&&currentY!==-1&&(draggingEndTime=beatmapFile.audioNode.getCurrentTime(),Ut(!1));const s=I.findNearestTimingPoint(t,"timingPointsList",!0),i=I.findNearestTimingPoint(t,"beatStepsList",!0);I.findNearestTimingPointIndex(t,"mergedPoints",!0),tt.CURRENT_BPM=i,tt.CURRENT_SV=s,!s.isKiai&&document.querySelector(".timingContainer").classList.contains("kiai")&&document.querySelector(".timingContainer").classList.remove("kiai"),s.isKiai&&!document.querySelector(".timingContainer").classList.contains("kiai")&&(document.querySelector(".timingContainer").classList.add("kiai"),document.querySelector(".timingContainer").style.animationDuration=`${i.beatstep}ms`,document.querySelector(".timingContainer").style.animationDelay=i.time>=0?`${i.time%i.beatstep}ms`:`${i.time+i.beatstep}ms`),document.querySelector(".BPM").textContent!==`${it(6e4/i.beatstep,2)}BPM`&&(document.querySelector(".BPM").textContent=`${it(6e4/i.beatstep,2)}BPM`),document.querySelector(".SV .multiplier").textContent!==`${s.svMultiplier.toFixed(2)}x`&&(document.querySelector(".SV .multiplier").textContent=`${s.svMultiplier.toFixed(2)}x`);const r=k(I.stats.approachRate*(mods.HR?1.4:1)*(mods.EZ?.5:1),0,10),n=I.difficultyRange(r,1800,1200,450),c=(m,h)=>(sliderAppearance.hitAnim?m.obj.killTime:Math.max(m.obj.killTime+800,m.obj.killTime))<h?-1:m.obj.time-n>h?1:0,a=[],d=yt(this.objectsList,t,c);if(d!==-1){let m=d-1,h=d+1;for(;m>=0&&c(this.objectsList[m],t)===0;)a.push(this.objectsList[m]),m--;for(a.reverse(),a.push(this.objectsList[d]);h<=this.objectsList.length-1&&c(this.objectsList[h],t)===0;)a.push(this.objectsList[h]),h++}this.filtered=a;const u=[];selectedHitObject.forEach(m=>{const h=yt(this.objectsList,m,(b,p)=>{if(b.obj.time===p)return 0;if(b.obj.time<p)return-1;if(b.obj.time>p)return 1});if(h===-1)return;const g=this.objectsList[h];u.push(g)});const f=this.judgementList.filter(m=>m.time-200<t&&m.time+1800+200>t);if(y.CONTAINER.removeChildren(),y.addToContainer([...f,...this.filtered.map(m=>m.obj).toReversed(),...this.filtered.map(m=>m.obj.approachCircleObj).filter(m=>m).toReversed(),...u.reduce((m,h)=>(h.obj instanceof Z&&m.push({obj:h.obj.hitCircle.selected},{obj:h.obj.selectedSliderEnd}),m.push({obj:h.obj.selected}),m),[]).toReversed()]),this.breakPeriods.some(m=>m[0]<t&&m[1]>t)?document.querySelector("#overlay").style.backgroundColor=`rgba(0 0 0 / ${document.querySelector("#dim").value*.7})`:document.querySelector("#overlay").style.backgroundColor=`rgba(0 0 0 / ${document.querySelector("#dim").value})`,f.forEach(m=>{m.draw(t)}),this.filtered.forEach(m=>{u.forEach(h=>h.obj.drawSelected()),m.obj.draw(Math.max(t,0))}),ScoreParser.CURSOR_DATA){const m=ScoreParser.CURSOR_DATA.slice(0,-1).findLastIndex(b=>b.time<=t),h=ScoreParser.CURSOR_DATA[m].x+(t-ScoreParser.CURSOR_DATA[m].time)/(ScoreParser.CURSOR_DATA[m+1].time-ScoreParser.CURSOR_DATA[m].time)*(ScoreParser.CURSOR_DATA[m+1].x-ScoreParser.CURSOR_DATA[m].x),g=ScoreParser.CURSOR_DATA[m].y+(t-ScoreParser.CURSOR_DATA[m].time)/(ScoreParser.CURSOR_DATA[m+1].time-ScoreParser.CURSOR_DATA[m].time)*(ScoreParser.CURSOR_DATA[m+1].y-ScoreParser.CURSOR_DATA[m].y);m!==-1&&y.CURSOR.update(m,h,g)}tt.lastTimestamp=t}reinitializeAllSliders(){const t=performance.now();this.objectsList.forEach(e=>{e.obj instanceof Z&&e.obj.reInitialize()}),console.log(`ReInitialize all sliders took: ${performance.now()-t}ms`)}static render(){var e,s;y.appResize(),T.resize(),y.FPS.text=`${Math.round(y.APP.ticker.FPS)}fps
${y.APP.ticker.deltaMS.toFixed(2)}ms`;const t=(e=beatmapFile==null?void 0:beatmapFile.audioNode)==null?void 0:e.getCurrentTime();rt.update(t??0),V.update(t??0),t&&((s=beatmapFile==null?void 0:beatmapFile.beatmapRenderData)!=null&&s.objectsController)&&(beatmapFile.beatmapRenderData.objectsController.draw(t),T.draw(t))}};o(tt,"CURRENT_BPM"),o(tt,"CURRENT_SV"),o(tt,"requestID",null),o(tt,"lastTimestamp"),o(tt,"lastRenderTime",0);let z=tt;const S=class S{static addToContainer(t){t.forEach(e=>{e&&S.CONTAINER.addChild(e.obj)})}static removeFromContainer(t){t.forEach(e=>{e&&S.CONTAINER.removeChild(e.obj)})}static CursorInit(){return new $t}static FPSInit(){PIXI.BitmapFont.from("Torus",{fontFamily:"Torus",fontSize:20,fontWeight:500,fill:16777215,align:"right"},{chars:[["a","z"],["A","Z"],["0","9"],". :"]});const t=new PIXI.BitmapText(`0fps
Infinite ms`,{fontName:"Torus",align:"right",fontSize:15});return t.anchor.set(1,1),t.x=S.APP.view.width-10,t.y=S.APP.view.height-10,t}static dragWindowInit(){const t=new PIXI.Graphics().lineStyle({width:2,color:16777215,alpha:1,alignment:0});return t.x=S.OFFSET_X,t.y=S.OFFSET_Y,t.alpha=0,t}static gridInit(){const t=new PIXI.Graphics().lineStyle({width:1,color:16777215,alpha:.1,alignment:.5}).drawRect(0,0,512,384),e=512/16,s=384/12;for(let c=0;c<16;c++)for(let a=0;a<12;a++)t.drawRect(c*e,a*s,e,s);const i=S.APP.renderer.generateTexture(t),r=new PIXI.Sprite(i);r.width=512,r.height=384,r.x=S.OFFSET_X,r.y=S.OFFSET_Y,r.alpha=1,r.scale.set(S.SCALE_RATE),r.interactive=!0;const n=c=>{if(!beatmapFile||!beatmapFile.isLoaded)return;const a=beatmapFile.audioNode.getCurrentTime();let{x:d,y:u}=S.CONTAINER.toLocal(c.global);d/=S.SCALE_RATE,u/=S.SCALE_RATE;const f=beatmapFile.beatmapRenderData.objectsController.filtered.filter(h=>vt(d,u,h)),m=f.length?f.reduce((h,g)=>{const b=Math.abs(h.time-a),p=Math.abs(g.time-a);return b>p?g:h}):void 0;m?c.ctrlKey?selectedHitObject=selectedHitObject.concat([m.obj.time]).filter((h,g,b)=>b.indexOf(h)===g):selectedHitObject=[m.obj.time]:didMove||(selectedHitObject=[]),didMove=!1};return r.on("click",c=>{n(c)}),r.on("touchstart",c=>{n(c)}),r.on("touchend",c=>{}),r.on("mousedown",c=>{if(!beatmapFile||!beatmapFile.isLoaded)return;let{x:a,y:d}=S.CONTAINER.toLocal(c.global);a/=S.WIDTH/512,d/=S.WIDTH/512,isDragging=!0,draggingStartTime=beatmapFile.audioNode.getCurrentTime(),startX=a,startY=d,S.DRAG_WINDOW.clear(),S.DRAG_WINDOW.lineStyle({width:1,color:16777215,alpha:1,alignment:0}),S.DRAG_WINDOW.beginFill(16777215,.2).drawRect(a,d,0,0).endFill(),S.DRAG_WINDOW.alpha=1}),r.on("mouseup",c=>{!beatmapFile||!beatmapFile.isLoaded||(currentX!==-1&&currentY,isDragging=!1,S.DRAG_WINDOW.alpha=0)}),r.on("mousemove",c=>{if(!beatmapFile||!beatmapFile.isLoaded)return;let{x:a,y:d}=S.CONTAINER.toLocal(c.global);a/=S.WIDTH/512,d/=S.WIDTH/512,isDragging&&(didMove=!0,draggingEndTime=beatmapFile.audioNode.getCurrentTime(),currentX=a,currentY=d,Ut(c),S.DRAG_WINDOW.clear(),S.DRAG_WINDOW.lineStyle({width:1,color:16777215,alpha:1,alignment:0}),S.DRAG_WINDOW.beginFill(16777215,.2).drawRect(Math.min(startX,a)*S.WIDTH/512,Math.min(startY,d)*S.WIDTH/512,Math.abs(a-startX)*S.WIDTH/512,Math.abs(d-startY)*S.WIDTH/512).endFill());const u=beatmapFile.audioNode.getCurrentTime(),f=beatmapFile.beatmapRenderData.objectsController.filtered.filter(h=>h.obj instanceof Z&&vt(a,d,h)),m=f.reduce((h,g)=>Math.abs(g.obj.time-u)<Math.abs(h.obj.time-u)?g:h,f[0]??null);beatmapFile.beatmapRenderData.objectsController.slidersList.forEach(h=>h.obj.isHover=!1),m&&(m.obj.isHover=!0)}),r}static containerInit(){const t=new PIXI.Container;return t.x=S.OFFSET_X,t.y=S.OFFSET_Y,t}static appResize(){S.appSizeSetup(),S.GRID.x=S.OFFSET_X,S.GRID.y=S.OFFSET_Y,S.GRID.scale.set(S.SCALE_RATE),S.CONTAINER.x=S.OFFSET_X,S.CONTAINER.y=S.OFFSET_Y,S.DRAG_WINDOW.x=S.OFFSET_X,S.DRAG_WINDOW.y=S.OFFSET_Y,S.FPS.x=S.APP.view.width-10,S.FPS.y=S.APP.view.height-10}static appSizeSetup(){let{width:t,height:e}=getComputedStyle(document.querySelector("#playerContainer"));t=parseInt(t)*window.devicePixelRatio,e=parseInt(e)*window.devicePixelRatio,!(S.WIDTH===t&&S.HEIGHT===e)&&(S.WIDTH=t,S.HEIGHT=e,S.APP.renderer.resize(S.WIDTH,S.HEIGHT),S.WIDTH/512>S.HEIGHT/384?S.WIDTH=S.HEIGHT/384*512:S.HEIGHT=S.WIDTH/512*384,S.WIDTH*=.8,S.HEIGHT*=.8,S.OFFSET_X=(S.APP.view.width-S.WIDTH)/2,S.OFFSET_Y=(S.APP.view.height-S.HEIGHT)/2,S.SCALE_RATE=S.WIDTH/512,S.APP.view.style.transform=`scale(${1/window.devicePixelRatio})`)}static appInit(){S.APP=new PIXI.Application({width:parseInt(getComputedStyle(document.querySelector("#playerContainer")).width),height:parseInt(getComputedStyle(document.querySelector("#playerContainer")).height),antialias:!0,autoDensity:!0,backgroundAlpha:0}),S.appSizeSetup()}static init(){S.appInit(),S.CONTAINER=S.containerInit(),S.GRID=S.gridInit(),S.DRAG_WINDOW=S.dragWindowInit(),S.FPS=S.FPSInit(),S.CURSOR=S.CursorInit(),S.APP.stage.addChild(S.GRID),S.APP.stage.addChild(S.DRAG_WINDOW),S.APP.stage.addChild(S.CONTAINER),S.APP.stage.addChild(S.FPS),S.APP.stage.addChild(S.CURSOR.obj),rt.init(),V.init(),T.init(),document.querySelector("#playerContainer").appendChild(S.APP.view),globalThis.__PIXI_APP__=S.APP,q.masterGainNode=audioCtx.createGain(),q.masterGainNode.gain.value=hsVol*masterVol,q.masterGainNode.connect(audioCtx.destination),S.APP.ticker.add(()=>{z.render()})}};o(S,"APP"),o(S,"CONTAINER"),o(S,"GRID"),o(S,"DRAG_WINDOW"),o(S,"FPS"),o(S,"CURSOR"),o(S,"WIDTH"),o(S,"HEIGHT"),o(S,"SLIDER_ACCURACY",1/500),o(S,"OFFSET_X"),o(S,"OFFSET_Y"),o(S,"SCALE_RATE",1),o(S,"IS_CLICKED",!1),o(S,"IS_RESIZING",!1);let y=S;const H=class H{static createSelectedHitCircle(){return new PIXI.Graphics().lineStyle({width:10,color:15911951,alpha:1,cap:"round",alignment:0}).arc(0,0,59,0,Math.PI*2)}static createHitCircle(){const t=new PIXI.Graphics,e=new PIXI.Graphics;e.beginFill(16777215),e.drawCircle(0,0,59),e.endFill();const s=new PIXI.Graphics;s.beginFill(10132122),s.drawCircle(0,0,47),s.endFill();const i=new PIXI.Graphics;return i.beginFill(3092271),i.drawCircle(0,0,35),i.endFill(),t.addChild(e),t.addChild(s),t.addChild(i),t}static createHitCircleOverlay(){return new PIXI.Graphics().lineStyle({width:4,color:16777215,alpha:1,cap:"round",alignment:0}).arc(0,0,67,0,Math.PI*2)}static createApproachCircle(){return new PIXI.Graphics().lineStyle({width:4,color:16777215,alpha:1,cap:"round",alignment:1}).drawCircle(0,0,59)}static createSliderBall(){const t=new PIXI.Graphics().lineStyle({width:15,color:16777215,alpha:1,cap:"round",alignment:0}).arc(0,0,59,0,Math.PI*2),e=new PIXI.Container;return e.addChild(t),e}static createSliderBallBG(){const e=document.createElement("canvas");e.width=59*2,e.height=59*2;const s=e.getContext("2d"),i=s.createLinearGradient(0,0,0,59*2);return i.addColorStop(0,"white"),i.addColorStop(1,"rgb(74, 74, 74)"),s.fillStyle=i,s.fillRect(0,0,59*2,59*2),PIXI.Texture.from(e)}static createSliderFollowCircle(){return new PIXI.Graphics().lineStyle({width:8,color:16777215,alpha:1,cap:"round",alignment:0}).beginFill(16777215,.3).drawCircle(0,0,128).endFill()}static createTexture(t){let e=null;switch(t){case"SELECTED_HIT_CIRCLE":e=H.createSelectedHitCircle();break;case"HIT_CIRCLE":e=H.createHitCircle();break;case"HIT_CIRCLE_OVERLAY":e=H.createHitCircleOverlay();break;case"SLIDER_BALL":e=H.createSliderBall();break;case"SLIDER_BALL_BG":return H.createSliderBallBG();case"SLIDER_FOLLOW_CIRCLE":e=H.createSliderFollowCircle();break}if(!e)return null;const{width:s,height:i}=e,r=PIXI.RenderTexture.create({width:s,height:i,multisample:PIXI.MSAA_QUALITY.MEDIUM});return y.APP.renderer.render(e,{renderTexture:r,transform:new PIXI.Matrix(1,0,0,1,s/2,i/2)}),y.APP.renderer.framebuffer.blit(),e.destroy(!0),r}static generateDefaultTextures(){H.SELECTED={texture:PIXI.Texture.from("static/legacy/hitcircleselect@2x.png"),isHD:!1},H.ARGON.HIT_CIRCLE={texture:H.createTexture("HIT_CIRCLE"),isHD:!1},H.ARGON.HIT_CIRCLE_OVERLAY={texture:H.createTexture("HIT_CIRCLE_OVERLAY"),isHD:!1},H.ARGON.SLIDER_B={ring:{texture:H.createTexture("SLIDER_BALL"),isHD:!1},arrow:{texture:PIXI.Texture.from("static/arrow.png"),isHD:!1},gradient:{texture:H.createTexture("SLIDER_BALL_BG"),isHD:!1}},H.ARGON.REVERSE_ARROW={arrow:{texture:PIXI.Texture.from("static/argon/reversearrow@2x.png"),isHD:!1},ring:{texture:PIXI.Texture.from("static/argon/repeat-edge-piece.png"),isHD:!1}},H.ARGON.SLIDER_FOLLOW_CIRCLE={texture:H.createTexture("SLIDER_FOLLOW_CIRCLE"),isHD:!1},H.ARGON.APPROACH_CIRCLE={texture:PIXI.Texture.from("static/argon/approachcircle@2x.png"),isHD:!1},H.ARGON.DEFAULTS=[...Array(10)].fill(null,0,10).map((t,e)=>({texture:PIXI.Texture.from(`static/argon/default-${e}@2x.png`),isHD:!1})),H.updateTextureFor("HIT_CIRCLE"),H.updateTextureFor("HIT_CIRCLE_OVERLAY"),H.updateTextureFor("SLIDER_B"),H.updateTextureFor("SLIDER_FOLLOW_CIRCLE"),H.updateTextureFor("REVERSE_ARROW"),H.updateTextureFor("APPROACH_CIRCLE"),H.updateNumberTextures([...Array(10)].fill({},0,10))}static updateNumberTextures(t,e){if(e){H.CUSTOM[e].DEFAULTS=t.map(({base64:s,isHD:i},r)=>({texture:s?PIXI.Texture.from(s):PIXI.Texture.from(`static/legacy/default-${r}@2x.png`),isHD:s?i:!1}));return}H.LEGACY.DEFAULTS=t.map(({base64:s,isHD:i},r)=>({texture:s?PIXI.Texture.from(s):PIXI.Texture.from(`static/legacy/default-${r}@2x.png`),isHD:s?i:!1}))}static updateTextureFor(t,e,s,i){i&&!H.CUSTOM[i]&&(H.CUSTOM[i]={DEFAULTS:null,HIT_CIRCLE:null,HIT_CIRCLE_OVERLAY:null,SLIDER_B:null,REVERSE_ARROW:null,SLIDER_FOLLOW_CIRCLE:null,APPROACH_CIRCLE:null});const r=i?H.CUSTOM[i]:H.LEGACY;switch(t){case"HIT_CIRCLE":r.HIT_CIRCLE={texture:e?PIXI.Texture.from(e):PIXI.Texture.from("static/legacy/hitcircle@2x.png"),isHD:e?s:!1};break;case"HIT_CIRCLE_OVERLAY":r.HIT_CIRCLE_OVERLAY={texture:e?PIXI.Texture.from(e):PIXI.Texture.from("static/legacy/hitcircleoverlay@2x.png"),isHD:e?s:!1};break;case"SLIDER_B":r.SLIDER_B={ring:{texture:e?PIXI.Texture.from(e):PIXI.Texture.from("static/legacy/sliderb0@2x.png"),isHD:e?s:!1},arrow:{texture:PIXI.Texture.from("static/empty.png"),isHD:!1},gradient:{texture:PIXI.Texture.from("static/empty.png"),isHD:!1}};break;case"REVERSE_ARROW":r.REVERSE_ARROW={arrow:{texture:PIXI.Texture.from(e??"static/legacy/reversearrow@2x.png"),isHD:e?s:!1},ring:{texture:PIXI.Texture.from("static/empty.png"),isHD:!1}};break;case"SLIDER_FOLLOW_CIRCLE":r.SLIDER_FOLLOW_CIRCLE={texture:PIXI.Texture.from(e??"static/legacy/sliderfollowcircle@2x.png"),isHD:e?s:!1};break;case"APPROACH_CIRCLE":r.APPROACH_CIRCLE={texture:PIXI.Texture.from(e??"static/legacy/approachcircle@2x.png"),isHD:e?s:!1};break}}};o(H,"SELECTED"),o(H,"ARGON",{DEFAULTS:null,HIT_CIRCLE:null,HIT_CIRCLE_OVERLAY:null,SLIDER_B:null,REVERSE_ARROW:null,SLIDER_FOLLOW_CIRCLE:null,APPROACH_CIRCLE:null}),o(H,"LEGACY",{DEFAULTS:null,HIT_CIRCLE:null,HIT_CIRCLE_OVERLAY:null,SLIDER_B:null,REVERSE_ARROW:null,SLIDER_FOLLOW_CIRCLE:null,APPROACH_CIRCLE:null}),o(H,"CUSTOM",{});let D=H;const E=class E{static async changeSkin(){if(skinning.type!=="4"){document.querySelector(".skinSelector").textContent=E.SKIN_NAME[skinning.type],console.log(skinning.type);return}if(!E.SKIN_LIST[E.SKIN_IDX]){skinning.type="2",E.SKIN_IDX=-1,document.querySelector(".skinSelector").textContent="Legacy";return}E.SLIDER_BORDER=E.SKIN_LIST[E.SKIN_IDX].ini.SLIDER_BORDER,E.SLIDER_TRACK_OVERRIDE=E.SKIN_LIST[E.SKIN_IDX].ini.SLIDER_TRACK_OVERRIDE,E.HIT_CIRCLE_PREFIX=E.SKIN_LIST[E.SKIN_IDX].ini.HIT_CIRCLE_PREFIX,E.DEFAULT_COLORS=E.SKIN_LIST[E.SKIN_IDX].ini.DEFAULT_COLORS,document.querySelector(".skinSelector").textContent=E.SKIN_LIST[E.SKIN_IDX].ini.NAME}static async getBase64(t,e){const s=t.find(r=>r.filename===`${e}@2x.png`)??t.find(r=>r.filename===`${e}.png`)??null;return s?{base64:await s.getData(new zip.Data64URIWriter("image/png")),isHD:s.filename.includes("@2x")}:{}}static async readSkinIni(t){var m,h,g,b;const r=(await(await t.find(p=>p.filename==="skin.ini").getData(new zip.BlobWriter("text/plain"))).text()).split(`
`),n=r.find(p=>p.includes("Name: ")).trim().replace("Name: ",""),c=(m=r.find(p=>p.includes("SliderBorder:")))==null?void 0:m.replaceAll(" ","").match(/[0-9]{0,3},[0-9]{0,3},[0-9]{0,3}/g).at(0).split(",").map(p=>p/255).concat([1]),a=(h=r.find(p=>p.includes("SliderTrackOverride:")))==null?void 0:h.replaceAll(" ","").match(/[0-9]{0,3},[0-9]{0,3},[0-9]{0,3}/g).at(0).split(",").map(p=>p/255).concat([1]),d=parseInt(((g=r.find(p=>p.includes("HitCircleOverlap:")))==null?void 0:g.replaceAll(" ","").match(/[0-9]+/g).at(0))??"0"),u=(b=r.find(p=>p.includes("HitCirclePrefix:")))==null?void 0:b.replaceAll(" ","").replaceAll("HitCirclePrefix:","").replaceAll("\r","");let f=r.filter(p=>/Combo[0-9]+:/g.test(p.replaceAll(" ","").replaceAll("\r"))&&p.replaceAll(" ","").slice(0,2)!=="//"&&p.replaceAll(" ","")[0]!==";"&&p.replaceAll(" ","")[0]!=="#").map(p=>`rgb(${p.replaceAll(" ","").replaceAll("\r","").replaceAll(/Combo[0-9]+:/g,"")})`).map(p=>parseInt(p.replaceAll("\r","").replaceAll("rgb(","").replaceAll(")","").split(",").map(A=>parseInt(A).toString(16).padStart(2,"0")).join(""),16));return f.length===0&&(f=[16760832,51712,1211647,15865913]),E.SLIDER_BORDER=c??null,E.SLIDER_TRACK_OVERRIDE=a??null,E.HIT_CIRCLE_OVERLAP=d??0,E.HIT_CIRCLE_PREFIX=u??"default",E.DEFAULT_COLORS=f,{NAME:n,SLIDER_BORDER:c??null,SLIDER_TRACK_OVERRIDE:a??null,HIT_CIRCLE_OVERLAP:d,HIT_CIRCLE_PREFIX:u??"default",DEFAULT_COLORS:f}}static async getHitsounds(t){const e=t.filter(i=>/^(normal|soft|drum)-(hitnormal|hitwhistle|hitclap|hitfinish|slidertick|sliderwhistle|sliderslide)([1-9][0-9]*)?/.test(i.filename)),s=[];for(const i of e){const r=new zip.BlobWriter(`audio/${i.filename.split(".").at(-1)}`),n=await i.getData(r),c=await E.readBlobAsBuffer(n);s.push({filename:i.filename,buf:c,blob:n})}return s}static async loadHitsounds(t,e){q.SAMPLES.CUSTOM[e]||(q.SAMPLES.CUSTOM[e]={});for(const s of["normal","soft","drum"])for(const i of["hitnormal","hitwhistle","hitclap","hitfinish","slidertick","sliderwhistle","sliderslide"]){const r=`${s}-${i}`,n=t.find(c=>c.filename.split(".")[0]===r);if(!n){q.SAMPLES.CUSTOM[e][r]=q.DEFAULT_SAMPLES.LEGACY[r];continue}try{const c=await audioCtx.decodeAudioData(n.buf);q.SAMPLES.CUSTOM[e][r]=c}catch{continue}}}static async readBlobAsBuffer(t){return await new Promise(s=>{let i=new FileReader;i.onload=r=>s(i.result),i.readAsArrayBuffer(t)})}static async getAllBase64s(t){const e=await E.getBase64(t,"hitcircle"),s=await E.getBase64(t,"hitcircleoverlay");let i=await E.getBase64(t,"sliderb0");const r=await E.getBase64(t,"sliderfollowcircle"),n=await E.getBase64(t,"reversearrow"),c=await E.getBase64(t,"approachcircle");let a=[...Array(10)].fill(null,0,10);i.base64||(i=await E.getBase64(t,"sliderb"));for(let d=0;d<10;d++)a[d]=await E.getBase64(t,`${E.HIT_CIRCLE_PREFIX}-${d}`)??{};return{HIT_CIRCLE:e,HIT_CIRCLE_OVERLAY:s,SLIDER_B:i,SLIDER_FOLLOW_CIRCLE:r,REVERSE_ARROW:n,APPROACH_CIRCLE:c,DEFAULTS:a}}static async import(t){E.SLIDER_BORDER=null,E.SLIDER_TRACK_OVERRIDE=null,E.HIT_CIRCLE_OVERLAP=0;const e=new zip.BlobReader(t),s=new zip.ZipReader(e),i=await s.getEntries(),r=await E.readSkinIni(i),n=await E.getHitsounds(i),c=await E.getAllBase64s(i),a={ini:r,samples:n,base64s:c};await Database.addToObjStore(a);const d=(await Database.getAllKeys()).at(-1);["HIT_CIRCLE","HIT_CIRCLE_OVERLAY","SLIDER_B","REVERSE_ARROW","DEFAULTS","SLIDER_FOLLOW_CIRCLE","APPROACH_CIRCLE"].forEach(u=>{if(!c[u])return;if(u==="DEFAULTS"){D.updateNumberTextures(c[u],d);return}const{base64:f,isHD:m}=c[u];D.updateTextureFor(u,f,m,d)}),await E.loadHitsounds(n,d),await Lt(),E.SKIN_IDX=d,skinning.type="4",E.changeSkin(),s.close(),new Notification(`${a.ini.NAME} imported`).notify()}};o(E,"HIT_CIRCLE",null),o(E,"HIT_CIRCLE_OVERLAY",null),o(E,"SLIDER_B",null),o(E,"SLIDER_FOLLOW_CIRCLE",null),o(E,"REVERSE_ARROW",null),o(E,"APPROACH_CIRCLE",null),o(E,"DEFAULTS",[...Array(10)].fill(null,0,10)),o(E,"SLIDER_BORDER",null),o(E,"SLIDER_TRACK_OVERRIDE",null),o(E,"HIT_CIRCLE_OVERLAP",0),o(E,"HIT_CIRCLE_OVERLAP_ARGON",20),o(E,"HIT_CIRCLE_PREFIX","default"),o(E,"DEFAULT_COLORS",[16760832,51712,1211647,15865913]),o(E,"SKIN_ENUM",{ARGON:"0",TINTED:"1",LEGACY:"2",TRIANGLES:"3",CUSTOM:"4",0:"ARGON",1:"LEGACY",2:"LEGACY",3:"LEGACY",4:"CUSTOM"}),o(E,"SKIN_NAME",{0:"Argon",1:"Tinted Legacy",2:"Legacy",3:"Triangles",4:""}),o(E,"SKIN_IDX",-1),o(E,"SKIN_LIST",[]);let L=E;document.querySelector(".loading").style.opacity=1;document.querySelector("#loadingText").textContent="Initializing";(async()=>(await le(),document.querySelector(".loading").style.opacity=0,document.querySelector(".loading").style.display="none",y.init(),D.generateDefaultTextures(),urlParams.get("b")&&/[0-9]+/g.test(urlParams.get("b"))&&(beatmapFile=new Nt(urlParams.get("b")),document.querySelector("#mapInput").value=urlParams.get("b"))))();document.querySelector("#playerContainer").addEventListener("dragover",function(l){l.preventDefault()});document.querySelector("#playerContainer").addEventListener("drop",function(l){if(l.preventDefault(),!l.dataTransfer.files.length)return;const t=l.dataTransfer.files[0];if(["osz","osr","osk"].includes(t.name.split(".").at(-1))){if(t.name.split(".").at(-1)==="osr"){new ScoreParser(t).getReplayData();return}if(t.name.split(".").at(-1)==="osk"){L.import(t);return}document.querySelector("#close").disabled=!0,Ft(t)}});
